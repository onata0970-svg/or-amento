<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ERP System - Vers√£o Final</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
/* --- CONFIGURA√á√ïES VISUAIS (DESIGN SYSTEM) --- */
:root {
    --primary: #0f172a;       /* Azul Petr√≥leo Escuro (Premium) */
    --accent: #2563eb;        /* Azul Real (Destaques) */
    --bg-app: #f1f5f9;        /* Fundo Cinza Claro */
    --surface: #ffffff;       /* Fundo Branco */
    --border: #e2e8f0;        /* Bordas Suaves */
    --text-main: #334155;     /* Texto Principal */
    --danger: #ef4444;        /* Vermelho para Erro/Excluir */
}

* { box-sizing: border-box; font-family: 'Inter', sans-serif; outline: none; -webkit-tap-highlight-color: transparent; }
body { margin: 0; background: var(--bg-app); color: var(--text-main); padding-bottom: 90px; }

/* TOAST (Notifica√ß√µes Flutuantes) */
#toast-container { position: fixed; top: 20px; right: 20px; z-index: 11000; }
.toast { background: #333; color: #fff; padding: 12px 24px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); animation: slideIn 0.3s; display: flex; align-items: center; gap: 10px; font-size: 13px; font-weight: 600; }
.toast.success { background: #059669; }
.toast.error { background: var(--danger); }
@keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

/* TELA DE LOGIN / RECUPERA√á√ÉO */
#auth-overlay { position: fixed; inset: 0; z-index: 10000; background: var(--primary); display: flex; align-items: center; justify-content: center; padding: 20px; }
.auth-card { background: var(--surface); width: 100%; max-width: 360px; padding: 40px; border-radius: 20px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
.pin-display { font-size: 32px; letter-spacing: 12px; font-weight: 800; border: 2px solid var(--border); border-radius: 12px; padding: 10px; width: 100%; text-align: center; margin: 25px 0; color: var(--primary); }
.pin-display:focus { border-color: var(--accent); }
.btn-auth { width: 100%; padding: 16px; background: var(--primary); color: #fff; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; font-size: 14px; transition: 0.2s; }
.btn-auth:hover { background: #1e293b; }
.input-std { width: 100%; padding: 14px; border-radius: 10px; border: 1px solid var(--border); margin-bottom: 15px; font-size: 15px; }
.auth-link { margin-top: 20px; font-size: 12px; color: #64748b; text-decoration: underline; cursor: pointer; }

/* NAVEGA√á√ÉO */
nav { position: fixed; bottom: 0; width: 100%; display: grid; grid-template-columns: repeat(5, 1fr); background: var(--surface); border-top: 1px solid var(--border); z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
nav div { padding: 12px 0; text-align: center; color: #94a3b8; cursor: pointer; font-size: 9px; font-weight: 700; text-transform: uppercase; transition: 0.2s; }
nav div i { font-size: 20px; display: block; margin-bottom: 6px; }
nav div.active { color: var(--accent); background: #eff6ff; border-top: 3px solid var(--accent); }

/* LAYOUT PRINCIPAL */
main { padding: 20px; max-width: 800px; margin: 0 auto; display: none; animation: fadeIn 0.3s; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.card { background: var(--surface); padding: 24px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 15px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02); }
.section-header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; font-size: 20px; font-weight: 800; color: var(--primary); }
.section-header i { color: var(--accent); }

/* FORMUL√ÅRIOS */
label { font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; display: block; margin-bottom: 6px; letter-spacing: 0.5px; }
input, select, textarea { width: 100%; padding: 14px; border-radius: 10px; border: 1px solid var(--border); margin-bottom: 15px; font-size: 15px; background: #fff; color: var(--primary); transition: 0.2s; }
input:focus, select:focus, textarea:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

.btn { padding: 16px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; font-size: 14px; }
.btn-primary { background: var(--primary); color: #fff; }
.btn-success { background: var(--accent); color: #fff; }
.btn:active { transform: scale(0.98); }

/* LISTAGEM */
.list-item { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 10px; }
.list-info { flex: 1; }
.list-title { font-weight: 700; color: var(--primary); font-size: 14px; }
.list-sub { font-size: 11px; color: #64748b; margin-top: 2px; }
.btn-delete { background: #fee2e2; color: var(--danger); border: none; padding: 8px 12px; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; margin-left: 10px; }

.input-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }

/* LOGO PREVIEW */
#logo-preview-box { text-align: center; margin-bottom: 15px; background: #f8fafc; padding: 15px; border-radius: 10px; border: 1px dashed var(--border); display: none; }
#current-logo-img { max-height: 80px; display: block; margin: 0 auto; }

/* --- CSS DO PDF (ESTILO A4) --- */
#preview { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.98); display: none; flex-direction: column; z-index: 2000; backdrop-filter: blur(5px); }
.preview-header { background: #fff; padding: 15px 20px; display: flex; justify-content: space-between; border-bottom: 1px solid #ddd; }
#pdf-wrapper { overflow: auto; padding: 40px; flex: 1; display: flex; justify-content: center; }
#pdf-box { 
    width: 210mm; min-height: 297mm; background: #fff; padding: 0; color: #1e293b; 
    box-shadow: 0 20px 50px rgba(0,0,0,0.5); position: relative; font-family: 'Inter', sans-serif; 
}

/* Design Interno PDF */
.p-header { background: #f8fafc; padding: 40px; border-bottom: 3px solid var(--primary); display: flex; justify-content: space-between; align-items: flex-start; }
.p-brand-col { display: flex; flex-direction: column; justify-content: center; max-width: 60%; }
.p-logo { max-height: 60px; margin-bottom: 15px; object-fit: contain; object-position: left; }
.p-title { margin: 0; color: var(--primary); font-size: 24px; text-transform: uppercase; letter-spacing: -0.5px; line-height: 1.2; }
.p-subtitle { margin: 5px 0 0; color: #475569; font-size: 11px; font-weight: 500; }

.p-meta-col { text-align: right; }
.p-badge { background: var(--accent); color: #fff; padding: 6px 12px; font-size: 11px; font-weight: 700; border-radius: 4px; display: inline-block; margin-bottom: 8px; }
.p-meta-row { font-size: 10px; color: #64748b; font-weight: 600; margin-top: 3px; }

.p-body { padding: 40px; }
.p-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 35px; }
.p-box { border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; }
.p-box-head { background: #f1f5f9; padding: 8px 15px; font-size: 9px; font-weight: 800; color: #475569; text-transform: uppercase; border-bottom: 1px solid #e2e8f0; letter-spacing: 0.5px; }
.p-box-content { padding: 15px; font-size: 11px; line-height: 1.5; color: #334155; }
.p-box-content b { color: var(--primary); font-size: 13px; display: block; margin-bottom: 4px; }

.p-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
.p-table th { text-align: left; padding: 10px; background: var(--primary); color: #fff; font-size: 9px; text-transform: uppercase; letter-spacing: 1px; }
.p-table td { padding: 12px 10px; border-bottom: 1px solid #e2e8f0; font-size: 10px; color: #334155; }
.p-table tr:nth-child(even) { background: #f8fafc; }
.p-table tr:last-child td { border-bottom: 2px solid var(--primary); }

.p-total-section { display: flex; justify-content: flex-end; }
.p-total-card { width: 240px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; text-align: right; }
.p-total-label { font-size: 10px; color: #64748b; text-transform: uppercase; font-weight: 700; }
.p-total-amount { font-size: 24px; color: var(--accent); font-weight: 800; margin-top: 5px; }

.p-terms { margin-top: 40px; padding: 15px; background: #f1f5f9; border-left: 4px solid #cbd5e1; border-radius: 4px; font-size: 9px; color: #475569; white-space: pre-wrap; line-height: 1.4; }

.p-sign-area { margin-top: 60px; display: grid; grid-template-columns: 1fr 1fr; gap: 60px; }
.p-sign-line { border-top: 1px solid #94a3b8; padding-top: 10px; text-align: center; font-size: 9px; font-weight: 700; color: #64748b; text-transform: uppercase; }

.p-footer { position: absolute; bottom: 0; width: 100%; background: var(--primary); color: #fff; text-align: center; padding: 12px; font-size: 8px; letter-spacing: 1px; }
</style>
</head>

<body onload="auth.init()">

<div id="toast-container"></div>

<div id="auth-overlay">
    <div id="view-login" class="auth-card">
        <i class="fas fa-file-invoice" style="font-size:48px; color:#2563eb; margin-bottom:20px"></i>
        <h2 style="margin:0; color:#0f172a">Bem-vindo</h2>
        <p style="color:#64748b; font-size:13px; margin-bottom:30px">Digite seu PIN de acesso</p>
        <input id="login-pin" type="tel" maxlength="4" class="pin-display" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeyup="if(this.value.length==4) auth.login()">
        <button class="btn-auth" onclick="auth.login()">ACESSAR SISTEMA</button>
        <div class="auth-link" onclick="auth.switch('recovery')">Esqueci meu PIN</div>
    </div>
    
    <div id="view-setup" class="auth-card" style="display:none">
        <h2 style="margin:0; color:#0f172a">Primeiro Acesso</h2>
        <p style="color:#64748b; font-size:13px; margin-bottom:20px">Configure sua seguran√ßa</p>
        <input id="setup-pin" type="tel" maxlength="4" class="input-std" placeholder="Crie um PIN (4 d√≠gitos)">
        <input id="setup-secret" type="text" class="input-std" placeholder="Palavra de Recupera√ß√£o (Ex: M√£e)">
        <button class="btn-auth" onclick="auth.setup()">SALVAR E ENTRAR</button>
    </div>

    <div id="view-recovery" class="auth-card" style="display:none">
        <h2 style="margin:0; color:#0f172a">Recuperar Acesso</h2>
        <p style="color:#64748b; font-size:13px; margin-bottom:20px">Qual sua palavra de recupera√ß√£o?</p>
        <input id="recovery-secret" type="text" class="input-std">
        <button class="btn-auth" onclick="auth.recover()">VERIFICAR</button>
        <div class="auth-link" onclick="auth.switch('login')">Cancelar</div>
    </div>
</div>

<nav id="nav-bar" style="display:none">
    <div onclick="ui.tab('v', this)" class="active"><i class="fas fa-calculator"></i>Or√ßamento</div>
    <div onclick="ui.tab('c', this)"><i class="fas fa-users"></i>Clientes</div>
    <div onclick="ui.tab('i', this)"><i class="fas fa-box-open"></i>Cat√°logo</div>
    <div onclick="ui.tab('f', this)"><i class="fas fa-chart-pie"></i>Resumo</div>
    <div onclick="ui.tab('e', this)"><i class="fas fa-building"></i>Empresa</div>
</nav>

<main id="app-container">

    <section id="v">
        <div class="section-header"><i class="fas fa-file-contract"></i> Novo Or√ßamento</div>
        <div class="card">
            <label>Selecione o Cliente</label>
            <select id="v-cli-select"></select>
            
            <div style="margin: 20px 0; border-top: 1px dashed #cbd5e1;"></div>

            <label>Adicionar Item</label>
            <select id="v-saved-items" onchange="app.fillItem(this)" style="background:#eff6ff; border-color:var(--accent)">
                <option value="">üìÇ Buscar no Cat√°logo (Opcional)</option>
            </select>

            <input id="v-item" placeholder="Descri√ß√£o do produto ou servi√ßo">

            <div class="input-row">
                <div>
                    <label>Unidade</label>
                    <select id="v-un">
                        <option value="un">UN</option>
                        <option value="m">Metro</option>
                        <option value="kg">KG</option>
                        <option value="h">Hora</option>
                        <option value="dia">Dia</option>
                        <option value="vb">Verba</option>
                    </select>
                </div>
                <div>
                    <label>Pre√ßo (R$)</label>
                    <input type="number" id="v-preco" placeholder="0.00">
                </div>
                <div>
                    <label>Qtd</label>
                    <input type="number" id="v-qtd" value="1">
                </div>
            </div>

            <button class="btn btn-primary" onclick="app.addItem()"><i class="fas fa-plus"></i> INCLUIR NA LISTA</button>
        </div>

        <div id="cart-list"></div>

        <button id="btn-gerar" class="btn btn-success" style="display:none; margin-bottom:50px; position:sticky; bottom:80px; box-shadow: 0 10px 25px -5px rgba(37, 99, 235, 0.4);" onclick="app.preview()">
            <i class="fas fa-file-pdf"></i> GERAR PDF FINAL
        </button>
    </section>

    <section id="c" style="display:none">
        <div class="section-header"><i class="fas fa-user-plus"></i> Gerenciar Clientes</div>
        <div class="card">
            <input id="c-n" placeholder="Nome / Raz√£o Social">
            <input id="c-d" placeholder="CPF / CNPJ">
            <input id="c-t" placeholder="Telefone / WhatsApp">
            <input id="c-e" placeholder="Endere√ßo Completo">
            <button class="btn btn-primary" onclick="app.saveClient()">SALVAR CLIENTE</button>
        </div>
        <div id="c-list"></div>
    </section>

    <section id="i" style="display:none">
        <div class="section-header"><i class="fas fa-boxes"></i> Cat√°logo de Itens</div>
        <div class="card">
            <input id="i-n" placeholder="Nome do Item / Servi√ßo">
            <div class="input-row" style="grid-template-columns: 1fr 1fr;">
                <select id="i-un"><option value="un">UN</option><option value="m">Metro</option><option value="kg">KG</option><option value="h">Hora</option></select>
                <input id="i-p" type="number" placeholder="Pre√ßo Padr√£o">
            </div>
            <button class="btn btn-primary" onclick="app.saveItem()">SALVAR NO CAT√ÅLOGO</button>
        </div>
        <div id="i-list"></div>
    </section>

    <section id="f" style="display:none">
        <div class="section-header"><i class="fas fa-chart-line"></i> Resumo da Sess√£o</div>
        <div class="card" style="text-align:center; padding:60px 20px;">
            <p style="color:#64748b; font-size:12px; text-transform:uppercase; letter-spacing:1px">Volume Or√ßado Hoje</p>
            <h1 id="saldo-box" style="font-size:42px; color:var(--accent); margin:15px 0">R$ 0,00</h1>
            <p style="font-size:11px; color:#94a3b8">Valor total de propostas geradas nesta sess√£o.</p>
        </div>
    </section>

    <section id="e" style="display:none">
        <div class="section-header"><i class="fas fa-building"></i> Configura√ß√µes</div>
        <div class="card">
            <label>Logotipo da Empresa</label>
            <div id="logo-preview-box">
                <img id="current-logo-img">
                <div style="font-size:10px; color:#64748b; margin-top:5px">Logo Atual</div>
            </div>
            <input type="file" id="e-logo-input" accept="image/*">
            
            <label>Nome da Empresa</label><input id="e-n">
            <label>CNPJ / Documento</label><input id="e-d">
            <label>Contato (Tel / Email)</label><input id="e-c">
            <label>Dados de Pagamento & Termos</label>
            <textarea id="e-p" rows="5" placeholder="Ex: Chave PIX: 000... Validade 15 dias..."></textarea>
            
            <button class="btn btn-success" onclick="app.saveConfig()">SALVAR DADOS</button>
        </div>
    </section>

</main>

<div id="preview">
    <div class="preview-header">
        <button class="btn" style="width:auto; background:#fff; color:#333; border:1px solid #ddd" onclick="ui.close()">VOLTAR</button>
        <button class="btn btn-success" style="width:auto" onclick="app.download()">BAIXAR PDF</button>
    </div>
    <div id="pdf-wrapper">
        <div id="pdf-box"></div>
    </div>
</div>

<script>
// --- UTILIT√ÅRIOS ---
const BRL = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });

const ui = {
    toast(msg, type='success') {
        const div = document.createElement('div');
        div.className = `toast ${type}`;
        div.innerHTML = type === 'success' ? `<i class="fas fa-check-circle"></i> ${msg}` : `<i class="fas fa-times-circle"></i> ${msg}`;
        document.getElementById('toast-container').appendChild(div);
        setTimeout(() => div.remove(), 3000);
    },
    tab(id, el) {
        document.querySelectorAll("section").forEach(s => s.style.display = "none");
        document.getElementById(id).style.display = "block";
        document.querySelectorAll("nav div").forEach(d => d.classList.remove("active"));
        el.classList.add("active");
        if(db) app.load();
    },
    close() { document.getElementById("preview").style.display = "none"; }
};

// --- AUTENTICA√á√ÉO SEGURA SIMPLIFICADA (Funciona Offline em qualquer lugar) ---
const auth = {
    // Hash simples e robusto para evitar problemas com CryptoAPI em file://
    hash(s) {
        let h = 0xdeadbeef;
        for(let i=0; i<s.length; i++) h = Math.imul(h ^ s.charCodeAt(i), 2654435761);
        return ((h ^ h >>> 16) >>> 0).toString(16);
    },
    init() {
        const d = localStorage.getItem("erp_v6_auth");
        if(d) this.switch('login'); else this.switch('setup');
    },
    switch(v) {
        ['login','setup','recovery'].forEach(i => document.getElementById('view-'+i).style.display='none');
        document.getElementById('view-'+v).style.display='block';
        document.getElementById('login-pin').value = ''; 
    },
    setup() {
        const p = document.getElementById('setup-pin').value;
        const s = document.getElementById('setup-secret').value;
        if(p.length !== 4) return ui.toast('PIN deve ter 4 d√≠gitos', 'error');
        if(s.length < 3) return ui.toast('Palavra curta demais', 'error');
        
        localStorage.setItem("erp_v6_auth", JSON.stringify({ pin: this.hash(p), secret: this.hash(s.toLowerCase().trim()) }));
        ui.toast('Seguran√ßa configurada!');
        this.enter();
    },
    login() {
        const p = document.getElementById('login-pin').value;
        if(p.length !== 4) return;
        const d = JSON.parse(localStorage.getItem("erp_v6_auth"));
        if(this.hash(p) === d.pin) this.enter();
        else { ui.toast('PIN Incorreto', 'error'); document.getElementById('login-pin').value=''; }
    },
    recover() {
        const s = document.getElementById('recovery-secret').value;
        const d = JSON.parse(localStorage.getItem("erp_v6_auth"));
        if(this.hash(s.toLowerCase().trim()) === d.secret) {
            ui.toast('Acesso liberado. Crie um novo PIN.');
            this.switch('setup');
        } else ui.toast('Palavra incorreta', 'error');
    },
    enter() {
        document.getElementById('auth-overlay').style.display = 'none';
        document.getElementById('nav-bar').style.display = 'grid';
        document.getElementById('app-container').style.display = 'block';
        app.init();
    }
};

// --- L√ìGICA DO APP ---
let db;
const app = {
    cart: [],
    items: [],
    clients: [],
    config: {},

    init() {
        const req = indexedDB.open("ERP_V6_DB", 1);
        req.onupgradeneeded = e => {
            const d = e.target.result;
            if(!d.objectStoreNames.contains("clients")) d.createObjectStore("clients", {keyPath:"id", autoIncrement:true});
            if(!d.objectStoreNames.contains("items")) d.createObjectStore("items", {keyPath:"id", autoIncrement:true});
            if(!d.objectStoreNames.contains("config")) d.createObjectStore("config", {keyPath:"id"});
        };
        req.onsuccess = e => { db = e.target.result; this.load(); };
    },

    load() {
        const tx = db.transaction(["clients","items","config"], "readonly");
        
        // Carrega Clientes com Bot√£o Excluir
        tx.objectStore("clients").getAll().onsuccess = e => {
            this.clients = e.target.result;
            const s = document.getElementById("v-cli-select");
            const val = s.value;
            s.innerHTML = '<option value="">-- Selecione o Cliente --</option>';
            this.clients.forEach(c => s.innerHTML += `<option value="${c.id}">${c.nome}</option>`);
            if(val) s.value = val;
            
            document.getElementById("c-list").innerHTML = this.clients.map(c => `
                <div class="list-item">
                    <div class="list-info">
                        <div class="list-title">${c.nome}</div>
                        <div class="list-sub">${c.doc || ''} ‚Ä¢ ${c.tel || ''}</div>
                    </div>
                    <button class="btn-delete" onclick="app.deleteClient(${c.id})"><i class="fas fa-trash"></i></button>
                </div>
            `).join("");
        };

        // Carrega Itens com Bot√£o Excluir
        tx.objectStore("items").getAll().onsuccess = e => {
            this.items = e.target.result;
            const s = document.getElementById("v-saved-items");
            s.innerHTML = '<option value="">üìÇ Buscar no Cat√°logo...</option>';
            this.items.forEach((i, idx) => s.innerHTML += `<option value="${idx}">${i.nome}</option>`);
            
            document.getElementById("i-list").innerHTML = this.items.map(i => `
                <div class="list-item">
                    <div class="list-info">
                        <div class="list-title">${i.nome}</div>
                        <div class="list-sub">${i.unidade} - ${BRL.format(i.preco)}</div>
                    </div>
                    <button class="btn-delete" onclick="app.deleteItem(${i.id})"><i class="fas fa-trash"></i></button>
                </div>
            `).join("");
        };

        // Carrega Config
        tx.objectStore("config").get(1).onsuccess = e => {
            const c = e.target.result || {};
            this.config = c;
            ['n','d','c','p'].forEach(k => document.getElementById('e-'+k).value = c[k] || '');
            if(c.logo) {
                document.getElementById('current-logo-img').src = c.logo;
                document.getElementById('logo-preview-box').style.display = 'block';
            }
        };
    },

    // --- FUN√á√ïES DE EXCLUS√ÉO (NOVO) ---
    deleteClient(id) {
        if(!confirm("Excluir este cliente?")) return;
        db.transaction("clients", "readwrite").objectStore("clients").delete(id).onsuccess = () => {
            ui.toast("Cliente removido"); this.load();
        };
    },
    deleteItem(id) {
        if(!confirm("Excluir este item do cat√°logo?")) return;
        db.transaction("items", "readwrite").objectStore("items").delete(id).onsuccess = () => {
            ui.toast("Item removido"); this.load();
        };
    },

    // --- FUN√á√ïES DE OR√áAMENTO ---
    fillItem(el) {
        if(!el.value) return;
        const i = this.items[el.value];
        document.getElementById("v-item").value = i.nome;
        document.getElementById("v-preco").value = i.preco;
        document.getElementById("v-un").value = i.unidade || 'un';
        document.getElementById("v-qtd").focus();
    },

    addItem() {
        const n = document.getElementById("v-item").value;
        const p = parseFloat(document.getElementById("v-preco").value);
        const q = parseFloat(document.getElementById("v-qtd").value);
        const u = document.getElementById("v-un").value;
        
        if(!n || isNaN(p) || isNaN(q)) return ui.toast("Preencha corretamente", "error");
        
        this.cart.push({ n, p, q, u });
        this.renderCart();
        
        document.getElementById("v-item").value = "";
        document.getElementById("v-preco").value = "";
        document.getElementById("v-qtd").value = "1";
        document.getElementById("v-saved-items").value = "";
        ui.toast("Item inclu√≠do");
    },

    renderCart() {
        const total = this.cart.reduce((a,b) => a+(b.p*b.q), 0);
        document.getElementById("cart-list").innerHTML = this.cart.map((i,x) => `
            <div class="list-item">
                <div style="flex:1">
                    <div style="font-weight:700; color:#1e293b">${i.n}</div>
                    <div style="font-size:11px; color:#64748b">${i.q} ${i.u} x ${BRL.format(i.p)}</div>
                </div>
                <div style="text-align:right">
                    <div style="font-weight:800; color:#2563eb">${BRL.format(i.p*i.q)}</div>
                    <div style="font-size:10px; color:#ef4444; margin-top:4px; cursor:pointer; font-weight:bold" onclick="app.cart.splice(${x},1);app.renderCart()">REMOVER</div>
                </div>
            </div>
        `).join("");
        
        document.getElementById("saldo-box").innerText = BRL.format(total);
        document.getElementById("btn-gerar").style.display = this.cart.length ? "flex" : "none";
    },

    // --- SALVAR DADOS ---
    saveClient() {
        const nome = document.getElementById("c-n").value;
        const doc = document.getElementById("c-d").value;
        const tel = document.getElementById("c-t").value;
        const end = document.getElementById("c-e").value;
        if(!nome) return ui.toast("Nome obrigat√≥rio", "error");
        db.transaction("clients","readwrite").objectStore("clients").add({nome, doc, tel, end}).onsuccess = () => {
            ui.toast("Cliente salvo"); this.load();
            ['c-n','c-d','c-t','c-e'].forEach(i => document.getElementById(i).value = "");
        };
    },

    saveItem() {
        const nome = document.getElementById("i-n").value;
        const preco = parseFloat(document.getElementById("i-p").value);
        const unidade = document.getElementById("i-un").value;
        if(!nome) return ui.toast("Erro no item", "error");
        db.transaction("items","readwrite").objectStore("items").add({nome, preco, unidade}).onsuccess = () => {
            ui.toast("Item salvo"); this.load();
            document.getElementById("i-n").value = "";
            document.getElementById("i-p").value = "";
        };
    },

    saveConfig() {
        const fileInput = document.getElementById('e-logo-input');
        const saveData = {
            id: 1,
            n: document.getElementById('e-n').value,
            d: document.getElementById('e-d').value,
            c: document.getElementById('e-c').value,
            p: document.getElementById('e-p').value,
            logo: this.config.logo
        };

        const commit = (data) => {
            db.transaction("config","readwrite").objectStore("config").put(data).onsuccess = () => {
                ui.toast("Configura√ß√£o salva!");
                this.load();
            };
        };

        if(fileInput.files.length > 0) {
            const reader = new FileReader();
            reader.onload = (e) => { saveData.logo = e.target.result; commit(saveData); };
            reader.readAsDataURL(fileInput.files[0]);
        } else {
            commit(saveData);
        }
    },

    // --- GERADOR DE PDF ---
    preview() {
        const c = this.config;
        const en = c.n || "Sua Empresa";
        const ed = c.d || "";
        const ec = c.c || "";
        const ep = c.p || "";
        const logo = c.logo;
        
        const cliId = document.getElementById("v-cli-select").value;
        const cli = this.clients.find(c => c.id == cliId) || { nome: "Consumidor Final", doc: "", tel: "", end: "" };
        const total = this.cart.reduce((a,b) => a+(b.p*b.q), 0);
        const orcNum = Math.floor(Math.random() * 8999) + 1000;

        const html = `
            <div class="p-header">
                <div class="p-brand-col">
                    ${logo ? `<img src="${logo}" class="p-logo">` : '<i class="fas fa-layer-group" style="font-size:30px; color:#2563eb; margin-bottom:15px"></i>'}
                    <h1 class="p-title">${en}</h1>
                    <p class="p-subtitle">CNPJ: ${ed}<br>Contato: ${ec}</p>
                </div>
                <div class="p-meta-col">
                    <div class="p-badge">OR√áAMENTO #${orcNum}</div>
                    <div class="p-meta-row">Data: ${new Date().toLocaleDateString()}</div>
                    <div class="p-meta-row">Validade: 15 Dias</div>
                </div>
            </div>

            <div class="p-body">
                <div class="p-grid">
                    <div class="p-box">
                        <div class="p-box-head">PRESTADOR DE SERVI√áOS</div>
                        <div class="p-box-content">
                            <b>${en}</b>
                            ${ed}<br>${ec}
                        </div>
                    </div>
                    <div class="p-box">
                        <div class="p-box-head">DADOS DO CLIENTE</div>
                        <div class="p-box-content">
                            <b>${cli.nome}</b>
                            ${cli.doc}<br>${cli.tel}<br>${cli.end || ''}
                        </div>
                    </div>
                </div>

                <table class="p-table">
                    <thead>
                        <tr>
                            <th style="width:45%">DESCRI√á√ÉO DO ITEM</th>
                            <th style="width:10%; text-align:center">QTD</th>
                            <th style="width:20%; text-align:right">UNIT√ÅRIO</th>
                            <th style="width:25%; text-align:right">TOTAL</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${this.cart.map(i => `
                            <tr>
                                <td>${i.n}</td>
                                <td style="text-align:center">${i.q} ${i.u}</td>
                                <td style="text-align:right">${BRL.format(i.p)}</td>
                                <td style="text-align:right; font-weight:700">${BRL.format(i.p*i.q)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>

                <div class="p-total-section">
                    <div class="p-total-card">
                        <div class="p-total-label">VALOR TOTAL DO OR√áAMENTO</div>
                        <div class="p-total-amount">${BRL.format(total)}</div>
                    </div>
                </div>

                ${ep ? `
                <div class="p-terms">
                    <div style="font-weight:800; margin-bottom:5px; color:#0f172a">TERMOS E FORMAS DE PAGAMENTO:</div>
                    ${ep}
                </div>` : ''}

                <div class="p-sign-area">
                    <div class="p-sign-line">ASSINATURA DO RESPONS√ÅVEL</div>
                    <div class="p-sign-line">DE ACORDO (CLIENTE)</div>
                </div>
            </div>

            <div class="p-footer">
                ESTE DOCUMENTO √â UMA PROPOSTA COMERCIAL E N√ÉO POSSUI VALIDADE FISCAL. GERADO ELETRONICAMENTE EM ${new Date().toLocaleString()}.
            </div>
        `;

        document.getElementById("pdf-box").innerHTML = html;
        document.getElementById("preview").style.display = "flex";
    },

    download() {
        const el = document.getElementById("pdf-box");
        const opt = { 
            margin: 0, 
            filename: `Orcamento_${Date.now()}.pdf`, 
            image: { type: 'jpeg', quality: 1 }, 
            html2canvas: { scale: 2, useCORS: true }, 
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } 
        };
        html2pdf().set(opt).from(el).save();
    }
};
</script>
</body>
</html>
