import React, { useState, useEffect, useMemo, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, collection, doc, setDoc, onSnapshot, addDoc, 
  deleteDoc, query, orderBy, serverTimestamp, updateDoc 
} from 'firebase/firestore';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { 
  Home, FileText, Wallet, Package, Settings, Plus, 
  Trash2, Printer, Save, Search, Bell, Menu, 
  MoreHorizontal, Share2, DollarSign, TrendingUp,
  Users, History, ChevronRight, X, MessageCircle, Send,
  Layout, ClipboardList, Calendar, CheckCircle, AlertTriangle, 
  Lock, Key, ShieldCheck, UserPlus, LogOut
} from 'lucide-react';
import { Chart as ChartJS, CategoryScale, LinearScale, PointElement, LineElement, Title, Tooltip, Legend, ArcElement } from 'chart.js';
import { Line, Doughnut } from 'react-chartjs-2';

// Registrar componentes do ChartJS
ChartJS.register(CategoryScale, LinearScale, PointElement, LineElement, Title, Tooltip, Legend, ArcElement);

// --- Configuração Firebase ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'erp-enterprise-v10-final';

const App = () => {
  const [firebaseUser, setFirebaseUser] = useState(null);
  const [appUser, setAppUser] = useState(null); // Utilizador lógico do ERP
  const [activeTab, setActiveTab] = useState('dash');
  const [authMode, setAuthMode] = useState('login'); // login, register, admin
  const [loading, setLoading] = useState(true);
  
  // --- Estados do Sistema ---
  const [profile, setProfile] = useState({ 
    nome: "Minha Empresa", 
    cnpj: "00.000.000/0001-00",
    tel: "(11) 99999-9999",
    endereco: "Rua Principal, 100",
    email: "contato@empresa.com"
  });
  
  const [catalogo, setCatalogo] = useState([]);
  const [transacoes, setTransacoes] = useState([]);
  const [clientes, setClientes] = useState([]);
  const [mensagens, setMensagens] = useState([]);
  const [posts, setPosts] = useState([]);
  const [orcamentosHistory, setOrcamentosHistory] = useState([]);
  const [usersList, setUsersList] = useState([]); // Lista de utilizadores para o ADM
  
  // --- Estados de Formulários ---
  const [loginForm, setLoginForm] = useState({ user: '', pass: '', name: '' });
  const [orcamentoItems, setOrcamentoItems] = useState([]);
  const [orcamentoCliente, setOrcamentoCliente] = useState(null);
  const [chatSelecionado, setChatSelecionado] = useState(null);
  const [inputMsg, setInputMsg] = useState("");
  
  // --- Autenticação Firebase (Infraestrutura) ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) { console.error("Erro Auth:", err); }
    };
    initAuth();
    onAuthStateChanged(auth, (u) => setFirebaseUser(u));
  }, []);

  // --- Sincronização de Dados (Lógica de Negócio) ---
  useEffect(() => {
    if (!firebaseUser) return;
    
    // Referências Globais
    const profRef = doc(db, 'artifacts', appId, 'public', 'data', 'config', 'perfil_v1');
    const catCol = collection(db, 'artifacts', appId, 'public', 'data', 'catalogo');
    const finCol = collection(db, 'artifacts', appId, 'public', 'data', 'financeiro');
    const cliCol = collection(db, 'artifacts', appId, 'public', 'data', 'clientes');
    const feedCol = collection(db, 'artifacts', appId, 'public', 'data', 'feed');
    const msgCol = collection(db, 'artifacts', appId, 'public', 'data', 'mensagens');
    const orcCol = collection(db, 'artifacts', appId, 'public', 'data', 'orcamentos');
    const usersCol = collection(db, 'artifacts', appId, 'public', 'data', 'app_users'); // Utilizadores do ERP

    // Listeners
    const unsubP = onSnapshot(profRef, (d) => d.exists() && setProfile(prev => ({...prev, ...d.data()})));
    const unsubC = onSnapshot(catCol, (s) => setCatalogo(s.docs.map(d => ({ id: d.id, ...d.data() }))));
    const unsubF = onSnapshot(finCol, (s) => setTransacoes(s.docs.map(d => ({ id: d.id, ...d.data() }))));
    const unsubCli = onSnapshot(cliCol, (s) => setClientes(s.docs.map(d => ({ id: d.id, ...d.data() }))));
    const unsubFeed = onSnapshot(feedCol, (s) => setPosts(s.docs.map(d => ({ id: d.id, ...d.data() }))));
    const unsubMsg = onSnapshot(msgCol, (s) => setMensagens(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => a.createdAt - b.createdAt)));
    const unsubOrc = onSnapshot(orcCol, (s) => setOrcamentosHistory(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => b.createdAt - a.createdAt)));
    
    // Lista de Utilizadores (Carregada para validar login e para o ADM gerir)
    const unsubUsers = onSnapshot(usersCol, (s) => {
        const list = s.docs.map(d => ({ id: d.id, ...d.data() }));
        setUsersList(list);
        setLoading(false);
    });
    
    return () => { 
      unsubP(); unsubC(); unsubF(); unsubCli(); unsubFeed(); unsubMsg(); unsubOrc(); unsubUsers();
    };
  }, [firebaseUser]);

  // --- Lógica de Login e Registro do ERP ---

  const handleRegister = async () => {
    const { user, pass, name } = loginForm;
    if (!user || !pass || !name) return alert("Preencha todos os campos.");
    
    const exists = usersList.find(u => u.username === user);
    if (exists) return alert("Utilizador já existe. Escolha outro nome de utilizador.");

    try {
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'app_users'), {
            username: user.toLowerCase(),
            password: pass,
            name: name,
            role: 'user',
            createdAt: Date.now(),
            status: 'trial', // trial, active, expired
            validUntil: Date.now() + (7 * 24 * 60 * 60 * 1000) // 7 dias
        });
        alert("Conta criada com sucesso! Aproveite seus 7 dias de teste.");
        setAuthMode('login');
    } catch (e) {
        console.error(e);
        alert("Erro ao criar conta.");
    }
  };

  const handleLogin = () => {
    const { user, pass } = loginForm;
    
    // Login Mestre (Hardcoded para segurança do dono)
    if (user === 'natanjkl' && pass === '91538300Aa') {
        setAppUser({
            username: 'natanjkl',
            name: 'Administrador Master',
            role: 'admin',
            status: 'active'
        });
        return;
    }

    // Login Utilizador Comum
    const found = usersList.find(u => u.username === user.toLowerCase() && u.password === pass);
    
    if (found) {
        // Verifica validade
        const now = Date.now();
        if (found.validUntil < now && found.role !== 'admin') {
             alert("O seu período de teste ou mensalidade expirou. Contacte o administrador para renovar.");
             // Não faz setAppUser, bloqueia o acesso
             return;
        }
        setAppUser(found);
    } else {
        alert("Utilizador ou palavra-passe incorretos.");
    }
  };

  // --- Funções de Admin (Controlo de Utilizadores) ---
  const ativarUsuario = async (uId, dias) => {
    if (appUser?.role !== 'admin') return;
    const novosDias = dias * 24 * 60 * 60 * 1000;
    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'app_users', uId), {
        status: 'active',
        validUntil: Date.now() + novosDias
    });
    alert(`Acesso renovado por ${dias} dias!`);
  };

  const excluirUsuario = async (uId) => {
    if (appUser?.role !== 'admin') return;
    if (confirm("Tem a certeza que deseja excluir este utilizador?")) {
        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'app_users', uId));
    }
  };

  // --- Funções do Sistema (Orçamentos, etc) ---
  const gerarPDF = (orcamentoData) => {
    const win = window.open('', '_blank');
    win.document.write(`
      <html>
        <head>
          <title>Orçamento #${orcamentoData.id.slice(-4)}</title>
          <style>
            body { font-family: 'Helvetica', sans-serif; padding: 40px; color: #333; }
            .header { border-bottom: 2px solid #2563eb; padding-bottom: 20px; margin-bottom: 30px; display: flex; justify-content: space-between; }
            h1 { color: #2563eb; margin: 0; font-size: 24px; }
            .info { font-size: 12px; color: #666; line-height: 1.5; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th { text-align: left; padding: 10px; background: #f8fafc; border-bottom: 1px solid #ddd; font-size: 12px; uppercase; }
            td { padding: 10px; border-bottom: 1px solid #eee; font-size: 13px; }
            .total { text-align: right; font-size: 20px; font-weight: bold; color: #2563eb; margin-top: 20px; }
          </style>
        </head>
        <body>
          <div class="header">
            <div>
              <h1>${profile.nome}</h1>
              <div class="info">${profile.endereco}<br>${profile.cnpj} | ${profile.tel}<br>${profile.email}</div>
            </div>
            <div style="text-align: right;">
              <h2>ORÇAMENTO</h2>
              <p>Data: ${orcamentoData.data}</p>
            </div>
          </div>
          <div style="margin-bottom: 30px;">
            <strong>Cliente:</strong> ${orcamentoData.clienteNome}
          </div>
          <table>
            <thead><tr><th>Descrição</th><th style="text-align: right;">Valor</th></tr></thead>
            <tbody>
              ${orcamentoData.items.map(i => `<tr><td>${i.nome}</td><td style="text-align: right;">R$ ${Number(i.preco).toFixed(2)}</td></tr>`).join('')}
            </tbody>
          </table>
          <div class="total">Total: R$ ${orcamentoData.total.toFixed(2)}</div>
          <script>window.onload = () => window.print();</script>
        </body>
      </html>
    `);
    win.document.close();
  };

  const salvarNovoOrcamento = async () => {
    if (!orcamentoCliente || orcamentoItems.length === 0) return alert("Selecione cliente e itens.");
    const total = orcamentoItems.reduce((acc, i) => acc + Number(i.preco), 0);
    const novoOrcamento = {
      clienteNome: orcamentoCliente.nome,
      clienteId: orcamentoCliente.id,
      items: orcamentoItems,
      total: total,
      data: new Date().toLocaleDateString('pt-BR'),
      pago: false,
      createdAt: Date.now()
    };
    const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orcamentos'), novoOrcamento);
    setOrcamentoItems([]);
    setOrcamentoCliente(null);
    if(confirm("Orçamento salvo! Deseja imprimir agora?")) {
        gerarPDF({...novoOrcamento, id: docRef.id});
    }
  };

  const ChartComponent = () => {
      const canvasRef = useRef(null);
      useEffect(() => {
          if(!canvasRef.current) return;
          const ctx = canvasRef.current.getContext('2d');
          const ent = transacoes.filter(t=>t.tipo==='entrada').reduce((a,b)=>a+b.valor,0);
          const sai = transacoes.filter(t=>t.tipo==='saida').reduce((a,b)=>a+b.valor,0);
          
          new window.Chart(ctx, {
             type: 'doughnut',
             data: {
                 labels: ['Entradas', 'Saídas'],
                 datasets: [{
                     data: [ent, sai],
                     backgroundColor: ['#10b981', '#ef4444'],
                     borderWidth: 0
                 }]
             },
             options: { responsive: true, maintainAspectRatio: false, cutout: '70%' }
          });
      }, [transacoes]);
      return <canvas ref={canvasRef} height="180"></canvas>;
  }


  // --- VISTAS ---

  if (loading) return <div className="flex h-screen items-center justify-center font-bold text-blue-600">Carregando Enterprise ERP...</div>;

  // TELA DE LOGIN / REGISTRO
  if (!appUser) {
    return (
        <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
            <div className="bg-white/10 backdrop-blur-lg border border-white/10 p-8 rounded-3xl w-full max-w-sm text-white shadow-2xl">
                <div className="text-center mb-8">
                    <div className="w-16 h-16 bg-blue-600 rounded-2xl mx-auto flex items-center justify-center text-3xl font-black mb-4">E</div>
                    <h1 className="text-2xl font-bold">Enterprise ERP</h1>
                    <p className="text-xs opacity-60 uppercase tracking-widest mt-1">Gestão Profissional V10</p>
                </div>

                {authMode === 'login' ? (
                    <div className="space-y-4 animate-in fade-in">
                        <input 
                            className="w-full p-4 bg-black/20 border border-white/10 rounded-xl outline-none focus:border-blue-500 transition-colors" 
                            placeholder="Utilizador" 
                            value={loginForm.user}
                            onChange={e => setLoginForm({...loginForm, user: e.target.value})}
                        />
                        <input 
                            className="w-full p-4 bg-black/20 border border-white/10 rounded-xl outline-none focus:border-blue-500 transition-colors" 
                            type="password" 
                            placeholder="Palavra-passe" 
                            value={loginForm.pass}
                            onChange={e => setLoginForm({...loginForm, pass: e.target.value})}
                        />
                        <button onClick={handleLogin} className="w-full py-4 bg-blue-600 hover:bg-blue-700 rounded-xl font-bold transition-all shadow-lg shadow-blue-900/50">
                            ENTRAR
                        </button>
                        
                        <div className="flex justify-between items-center mt-6 pt-6 border-t border-white/10">
                            <span className="text-xs opacity-50">Não tem conta?</span>
                            <button onClick={() => setAuthMode('register')} className="text-xs font-bold text-blue-400 hover:text-white">CRIAR CONTA</button>
                        </div>
                    </div>
                ) : (
                    <div className="space-y-4 animate-in fade-in">
                        <input 
                            className="w-full p-4 bg-black/20 border border-white/10 rounded-xl outline-none" 
                            placeholder="Nome Completo / Empresa" 
                            value={loginForm.name}
                            onChange={e => setLoginForm({...loginForm, name: e.target.value})}
                        />
                        <input 
                            className="w-full p-4 bg-black/20 border border-white/10 rounded-xl outline-none" 
                            placeholder="Criar Utilizador" 
                            value={loginForm.user}
                            onChange={e => setLoginForm({...loginForm, user: e.target.value})}
                        />
                        <input 
                            className="w-full p-4 bg-black/20 border border-white/10 rounded-xl outline-none" 
                            type="password" 
                            placeholder="Criar Palavra-passe" 
                            value={loginForm.pass}
                            onChange={e => setLoginForm({...loginForm, pass: e.target.value})}
                        />
                        <button onClick={handleRegister} className="w-full py-4 bg-emerald-600 hover:bg-emerald-700 rounded-xl font-bold transition-all">
                            REGISTAR (7 DIAS GRÁTIS)
                        </button>
                        <button onClick={() => setAuthMode('login')} className="w-full py-2 text-xs text-white/50 hover:text-white">
                            Voltar ao Login
                        </button>
                    </div>
                )}
            </div>
        </div>
    );
  }

  // APP PRINCIPAL
  return (
    <div className="min-h-screen bg-slate-50 text-slate-900 font-sans pb-24 md:pb-0 md:pl-64">
      
      {/* Sidebar Desktop */}
      <aside className="hidden md:flex fixed top-0 left-0 h-screen w-64 bg-slate-900 text-white flex-col p-4 z-50">
        <div className="p-4 mb-6">
            <h1 className="text-xl font-black tracking-tighter flex items-center gap-2"><div className="w-8 h-8 bg-blue-600 rounded flex items-center justify-center">E</div> Enterprise</h1>
            <p className="text-[10px] text-slate-500 mt-1 uppercase tracking-widest">{appUser.role === 'admin' ? 'Master Admin' : 'Standard License'}</p>
        </div>
        
        <nav className="space-y-1 flex-1">
            <button onClick={() => setActiveTab('feed')} className={`w-full flex items-center gap-3 p-3 rounded-lg text-sm font-medium transition-colors ${activeTab === 'feed' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:bg-white/5'}`}><Home size={18}/> Dashboard</button>
            <button onClick={() => setActiveTab('orcamentos')} className={`w-full flex items-center gap-3 p-3 rounded-lg text-sm font-medium transition-colors ${activeTab === 'orcamentos' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:bg-white/5'}`}><ClipboardList size={18}/> Orçamentos</button>
            <button onClick={() => setActiveTab('financeiro')} className={`w-full flex items-center gap-3 p-3 rounded-lg text-sm font-medium transition-colors ${activeTab === 'financeiro' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:bg-white/5'}`}><Wallet size={18}/> Financeiro</button>
            <button onClick={() => setActiveTab('clientes')} className={`w-full flex items-center gap-3 p-3 rounded-lg text-sm font-medium transition-colors ${activeTab === 'clientes' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:bg-white/5'}`}><Users size={18}/> Clientes</button>
            <button onClick={() => setActiveTab('chat')} className={`w-full flex items-center gap-3 p-3 rounded-lg text-sm font-medium transition-colors ${activeTab === 'chat' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:bg-white/5'}`}><MessageCircle size={18}/> Chat</button>
            
            {appUser.role === 'admin' && (
                <div className="pt-4 mt-4 border-t border-white/10">
                    <p className="px-3 text-[10px] font-bold text-slate-500 uppercase mb-2">Administração</p>
                    <button onClick={() => setActiveTab('admin_users')} className={`w-full flex items-center gap-3 p-3 rounded-lg text-sm font-medium transition-colors ${activeTab === 'admin_users' ? 'bg-amber-500 text-black' : 'text-amber-500 hover:bg-white/5'}`}><ShieldCheck size={18}/> Gerir Utilizadores</button>
                </div>
            )}
        </nav>

        <button onClick={() => setAppUser(null)} className="flex items-center gap-3 p-3 text-rose-400 hover:text-white hover:bg-rose-500/20 rounded-lg text-sm font-medium transition-colors mt-auto">
            <LogOut size={18}/> Sair do Sistema
        </button>
      </aside>

      {/* Mobile Header & Nav */}
      <header className="md:hidden fixed top-0 w-full h-16 bg-white border-b border-slate-200 z-50 flex items-center justify-between px-4">
        <span className="font-black text-blue-600 text-lg">Enterprise</span>
        <button onClick={() => setAppUser(null)}><LogOut size={20} className="text-slate-400"/></button>
      </header>
      <nav className="md:hidden fixed bottom-0 w-full h-16 bg-white border-t border-slate-200 z-50 flex justify-around items-center">
        <button onClick={() => setActiveTab('feed')} className={`p-2 rounded-xl ${activeTab === 'feed' ? 'text-blue-600 bg-blue-50' : 'text-slate-400'}`}><Home size={24}/></button>
        <button onClick={() => setActiveTab('orcamentos')} className={`p-2 rounded-xl ${activeTab === 'orcamentos' ? 'text-blue-600 bg-blue-50' : 'text-slate-400'}`}><FileText size={24}/></button>
        <button onClick={() => setActiveTab('financeiro')} className={`p-2 rounded-xl ${activeTab === 'financeiro' ? 'text-blue-600 bg-blue-50' : 'text-slate-400'}`}><Wallet size={24}/></button>
        {appUser.role === 'admin' ? (
             <button onClick={() => setActiveTab('admin_users')} className={`p-2 rounded-xl ${activeTab === 'admin_users' ? 'text-amber-600 bg-amber-50' : 'text-slate-400'}`}><ShieldCheck size={24}/></button>
        ) : (
             <button onClick={() => setActiveTab('chat')} className={`p-2 rounded-xl ${activeTab === 'chat' ? 'text-blue-600 bg-blue-50' : 'text-slate-400'}`}><MessageCircle size={24}/></button>
        )}
      </nav>

      {/* Conteúdo Principal */}
      <main className="pt-20 md:pt-8 p-4 md:p-8 max-w-5xl mx-auto">
        
        {/* DASHBOARD */}
        {activeTab === 'feed' && (
            <div className="space-y-6 animate-in fade-in">
                <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col md:flex-row gap-6 items-center">
                    <div className="flex-1">
                        <h2 className="text-2xl font-bold text-slate-800">Olá, {appUser.name}</h2>
                        <p className="text-slate-500">Aqui está o resumo do seu negócio hoje.</p>
                    </div>
                    <div className="flex gap-4">
                        <div className="text-right">
                            <p className="text-xs font-bold text-slate-400 uppercase">Validade do Acesso</p>
                            <p className={`font-bold ${appUser.role === 'admin' ? 'text-amber-500' : 'text-blue-600'}`}>
                                {appUser.role === 'admin' ? 'VITALÍCIO' : new Date(appUser.validUntil).toLocaleDateString()}
                            </p>
                        </div>
                    </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div className="bg-blue-600 p-6 rounded-2xl text-white shadow-lg shadow-blue-200">
                        <Wallet className="opacity-80 mb-4"/>
                        <p className="text-xs font-bold opacity-70 uppercase">Saldo em Caixa</p>
                        <p className="text-3xl font-black mt-1">R$ {
                            (transacoes.reduce((a,b) => b.tipo === 'entrada' ? a+b.valor : a-b.valor, 0)).toFixed(2)
                        }</p>
                    </div>
                    <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col justify-center items-center">
                         <ChartComponent />
                         <p className="text-xs font-bold text-slate-400 mt-4 uppercase">Receitas vs Despesas</p>
                    </div>
                    <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                        <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2"><History size={16}/> Recentes</h3>
                        <div className="space-y-3">
                            {transacoes.slice(0, 3).map(t => (
                                <div key={t.id} className="flex justify-between text-sm">
                                    <span className="text-slate-600">{t.descricao}</span>
                                    <span className={t.tipo === 'entrada' ? 'text-emerald-600 font-bold' : 'text-rose-600 font-bold'}>
                                        {t.tipo === 'entrada' ? '+' : '-'} {t.valor}
                                    </span>
                                </div>
                            ))}
                            {transacoes.length === 0 && <p className="text-slate-400 text-xs text-center">Sem dados.</p>}
                        </div>
                    </div>
                </div>
            </div>
        )}

        {/* ORÇAMENTOS */}
        {activeTab === 'orcamentos' && (
            <div className="grid md:grid-cols-2 gap-6 animate-in fade-in">
                <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm space-y-4">
                    <h2 className="text-lg font-bold flex items-center gap-2 text-blue-600"><FileText/> Gerar Orçamento</h2>
                    
                    <select className="w-full p-3 bg-slate-50 border rounded-xl" onChange={e => {
                        const c = clientes.find(cli => cli.id === e.target.value);
                        setOrcamentoCliente(c);
                    }}>
                        <option value="">Selecione o Cliente</option>
                        {clientes.map(c => <option key={c.id} value={c.id}>{c.nome}</option>)}
                    </select>

                    <div className="bg-slate-50 p-4 rounded-xl space-y-3">
                        <p className="text-xs font-bold text-slate-400 uppercase">Adicionar Item</p>
                        <select className="w-full p-2 border rounded-lg text-sm" onChange={e => {
                            if(e.target.value) {
                                const item = JSON.parse(e.target.value);
                                setOrcamentoItems([...orcamentoItems, item]);
                            }
                        }}>
                            <option value="">Do Catálogo...</option>
                            {catalogo.map(i => <option key={i.id} value={JSON.stringify(i)}>{i.nome} - R$ {i.preco}</option>)}
                        </select>
                        
                        <div className="max-h-32 overflow-y-auto space-y-2 pt-2">
                            {orcamentoItems.map((it, idx) => (
                                <div key={idx} className="flex justify-between items-center bg-white p-2 rounded border text-sm">
                                    <span>{it.nome}</span>
                                    <div className="flex items-center gap-2">
                                        <b>R$ {it.preco}</b>
                                        <X size={14} className="text-red-400 cursor-pointer" onClick={() => setOrcamentoItems(orcamentoItems.filter((_, i) => i !== idx))}/>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    
                    <div className="flex justify-between items-center pt-2">
                        <span className="font-bold text-slate-500">TOTAL</span>
                        <span className="text-2xl font-black text-blue-600">R$ {orcamentoItems.reduce((a,b)=>a+Number(b.preco),0).toFixed(2)}</span>
                    </div>

                    <button onClick={salvarNovoOrcamento} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition-all flex items-center justify-center gap-2">
                        <Printer size={18}/> Salvar e Imprimir
                    </button>
                </div>

                <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                    <h3 className="font-bold mb-4 text-slate-700">Histórico de Orçamentos</h3>
                    <div className="space-y-3 overflow-y-auto max-h-[500px]">
                        {orcamentosHistory.map(orc => (
                            <div key={orc.id} className="p-3 border rounded-xl hover:bg-slate-50 transition-colors flex justify-between items-center">
                                <div>
                                    <p className="font-bold text-sm">{orc.clienteNome}</p>
                                    <p className="text-xs text-slate-400">{orc.data} • {orc.items.length} itens</p>
                                </div>
                                <div className="flex items-center gap-3">
                                    <span className="font-bold text-blue-600 text-sm">R$ {orc.total.toFixed(2)}</span>
                                    <button onClick={() => gerarPDF(orc)} className="p-2 text-slate-400 hover:text-blue-600"><Printer size={16}/></button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        )}

        {/* --- FINANCEIRO --- */}
        {activeTab === 'financeiro' && (
            <div className="max-w-2xl mx-auto space-y-6 animate-in fade-in">
                <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                    <h2 className="text-lg font-bold mb-4 flex items-center gap-2"><DollarSign/> Lançamento de Caixa</h2>
                    <form onSubmit={async (e) => {
                        e.preventDefault();
                        const f = e.target;
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'financeiro'), {
                            descricao: f.desc.value, valor: Number(f.valor.value), tipo: f.tipo.value,
                            data: new Date().toLocaleDateString('pt-BR'), createdAt: Date.now()
                        });
                        f.reset();
                    }} className="space-y-3">
                        <input name="desc" placeholder="Descrição" required className="w-full p-3 bg-slate-50 border rounded-xl outline-none" />
                        <div className="flex gap-2">
                            <input name="valor" type="number" step="0.01" placeholder="Valor" required className="flex-1 p-3 bg-slate-50 border rounded-xl outline-none" />
                            <select name="tipo" className="p-3 bg-slate-50 border rounded-xl outline-none font-bold">
                                <option value="entrada">Entrada (+)</option>
                                <option value="saida">Saída (-)</option>
                            </select>
                        </div>
                        <button className="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold hover:bg-emerald-700">Registrar</button>
                    </form>
                </div>
                
                <div className="bg-white rounded-2xl border border-slate-200 overflow-hidden">
                    {transacoes.sort((a,b)=>b.createdAt - a.createdAt).map(t => (
                        <div key={t.id} className="p-4 border-b last:border-0 flex justify-between items-center">
                            <div>
                                <p className="font-bold text-sm">{t.descricao}</p>
                                <p className="text-xs text-slate-400">{t.data}</p>
                            </div>
                            <div className="flex items-center gap-4">
                                <span className={`font-bold ${t.tipo==='entrada'?'text-emerald-600':'text-rose-600'}`}>
                                    {t.tipo==='entrada'?'+':'-'} R$ {t.valor.toFixed(2)}
                                </span>
                                <button onClick={() => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'financeiro', t.id))} className="text-slate-300 hover:text-rose-500"><Trash2 size={16}/></button>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        )}

        {/* --- CLIENTES --- */}
        {activeTab === 'clientes' && (
            <div className="max-w-2xl mx-auto space-y-6 animate-in fade-in">
                <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                    <h2 className="text-lg font-bold mb-4 flex items-center gap-2"><Users/> Novo Cliente</h2>
                    <form onSubmit={async (e) => {
                        e.preventDefault();
                        const f = e.target;
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'clientes'), {
                            nome: f.nome.value, tel: f.tel.value, createdAt: Date.now()
                        });
                        f.reset();
                    }} className="space-y-3">
                        <input name="nome" placeholder="Nome Completo" required className="w-full p-3 bg-slate-50 border rounded-xl outline-none" />
                        <input name="tel" placeholder="WhatsApp / Telefone" required className="w-full p-3 bg-slate-50 border rounded-xl outline-none" />
                        <button className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700">Cadastrar</button>
                    </form>
                </div>

                <div className="space-y-2">
                    {clientes.map(c => (
                        <div key={c.id} className="bg-white p-4 rounded-xl border border-slate-200 flex justify-between items-center shadow-sm">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center font-bold text-slate-500">{c.nome.charAt(0)}</div>
                                <div><p className="font-bold text-sm">{c.nome}</p><p className="text-xs text-slate-400">{c.tel}</p></div>
                            </div>
                            <button onClick={() => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'clientes', c.id))} className="text-slate-300 hover:text-rose-500"><Trash2 size={18}/></button>
                        </div>
                    ))}
                </div>
            </div>
        )}

        {/* --- ADMIN MASTER --- */}
        {activeTab === 'admin_users' && appUser?.role === 'admin' && (
            <div className="max-w-4xl mx-auto space-y-6 animate-in fade-in">
                <div className="bg-amber-50 border border-amber-200 p-6 rounded-2xl">
                    <h2 className="text-2xl font-black text-amber-800 flex items-center gap-2"><ShieldCheck/> Painel Master</h2>
                    <p className="text-amber-700 text-sm mt-2">Gerencie os acessos e validade das licenças dos utilizadores.</p>
                </div>

                <div className="grid md:grid-cols-2 gap-4">
                    {usersList.filter(u => u.username !== 'natanjkl').map(u => {
                        const isExpired = Date.now() > u.validUntil;
                        const daysLeft = Math.ceil((u.validUntil - Date.now()) / (1000 * 60 * 60 * 24));
                        
                        return (
                            <div key={u.id} className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                                <div className="flex justify-between items-start mb-4">
                                    <div>
                                        <p className="font-bold text-lg">{u.name}</p>
                                        <p className="text-xs text-slate-400 font-mono">@{u.username}</p>
                                    </div>
                                    <span className={`px-2 py-1 rounded text-[10px] font-bold uppercase ${isExpired ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>
                                        {isExpired ? 'Expirado' : `${daysLeft} dias`}
                                    </span>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => ativarUsuario(u.id, 30)} className="flex-1 py-2 bg-blue-50 text-blue-600 text-xs font-bold rounded-lg hover:bg-blue-100">Renovar 30d</button>
                                    <button onClick={() => excluirUsuario(u.id)} className="px-3 py-2 bg-rose-50 text-rose-600 text-xs font-bold rounded-lg hover:bg-rose-100">Excluir</button>
                                </div>
                            </div>
                        );
                    })}
                </div>
            </div>
        )}

      </main>
    </div>
  );
};

export default App;
