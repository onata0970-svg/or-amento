<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP ENTERPRISE V10.2</title>
    
    <!-- Bibliotecas Essenciais -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --p: #2563eb; --s: #10b981; --d: #ef4444; 
            --dark: #0f172a; --slate: #64748b; --bg: #f1f5f9;
            --card: #ffffff; --border: #e2e8f0;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        body { background: var(--bg); color: var(--dark); padding-bottom: 80px; }

        /* Auth */
        #auth-screen { position: fixed; inset: 0; z-index: 9999; background: var(--dark); display: flex; align-items: center; justify-content: center; }
        .auth-card { background: rgba(255,255,255,0.05); padding: 40px; border-radius: 24px; width: 90%; max-width: 400px; text-align: center; color: white; border: 1px solid rgba(255,255,255,0.1); }

        /* Nav */
        nav { position: fixed; bottom: 0; width: 100%; background: var(--dark); display: none; grid-template-columns: repeat(4, 1fr); padding: 12px 0; z-index: 1000; border-top: 1px solid rgba(255,255,255,0.1); }
        nav div { color: #94a3b8; font-size: 10px; text-align: center; cursor: pointer; transition: 0.2s; }
        nav div i { display: block; font-size: 20px; margin-bottom: 4px; font-style: normal; }
        nav div.active { color: white; font-weight: bold; transform: translateY(-2px); }

        /* UI Base */
        main { padding: 20px; max-width: 850px; margin: auto; display: none; }
        .card { background: var(--card); border-radius: 16px; padding: 20px; border: 1px solid var(--border); margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        h2 { font-size: 18px; margin-bottom: 15px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        
        .field-group { margin-bottom: 15px; }
        label { display: block; font-size: 11px; font-weight: 700; color: var(--slate); margin-bottom: 6px; text-transform: uppercase; }
        input, select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: #f8fafc; font-size: 14px; outline: none; }
        
        .btn { padding: 14px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; width: 100%; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-p { background: var(--p); color: white; }
        .btn-s { background: var(--s); color: white; }
        
        .item-row { display: flex; justify-content: space-between; padding: 12px; background: #f8fafc; border-radius: 8px; margin-bottom: 8px; font-size: 14px; border: 1px solid #edf2f7; }

        /* MODAL PREVIEW */
        .overlay { position: fixed; inset: 0; display: none; background: rgba(0,0,0,0.85); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal { background: #333; width: 98%; height: 95vh; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; }
        #preview-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; align-items: center; background: #525659; }

        /* PDF A4 ESTRITO - O segredo est√° aqui */
        .pdf-page { 
            width: 210mm; 
            min-height: 297mm; 
            background: white; 
            padding: 20mm; 
            color: #111; 
            box-sizing: border-box;
            position: relative;
            font-size: 12px;
            display: block;
        }

        .pdf-header { display: flex; justify-content: space-between; border-bottom: 3px solid #2563eb; padding-bottom: 20px; margin-bottom: 25px; }
        .empresa-info h1 { font-size: 26px; color: #2563eb; margin-bottom: 5px; font-weight: bold; }
        .empresa-info p { font-size: 11px; color: #444; margin: 2px 0; }
        
        .doc-tipo { text-align: right; }
        .doc-tipo .badge { background: #2563eb; color: white; padding: 8px 20px; font-weight: bold; font-size: 18px; border-radius: 4px; display: inline-block; margin-bottom: 8px; }

        .cliente-box { background: #f1f5f9; padding: 15px; border-radius: 6px; margin-bottom: 25px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; border: 1px solid #cbd5e1; }
        .cliente-box h3 { grid-column: span 2; font-size: 14px; border-bottom: 1px solid #cbd5e1; padding-bottom: 5px; margin-bottom: 5px; text-transform: uppercase; }
        .cliente-box div b { display: block; font-size: 9px; color: #64748b; text-transform: uppercase; }
        .cliente-box div p { font-size: 12px; font-weight: 500; }

        .tabela-pdf { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .tabela-pdf th { background: #f8fafc; border-bottom: 2px solid #2563eb; text-align: left; padding: 12px 10px; font-size: 11px; }
        .tabela-pdf td { padding: 12px 10px; border-bottom: 1px solid #e2e8f0; }

        .total-pdf { margin-top: 30px; text-align: right; border-top: 2px solid #2563eb; padding-top: 15px; }
        .total-pdf h2 { font-size: 32px; color: #2563eb; font-weight: 800; }

        .footer-pdf { position: absolute; bottom: 15mm; left: 20mm; right: 20mm; border-top: 1px solid #eee; padding-top: 10px; font-size: 10px; text-align: center; color: #999; }

        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 8px; display: none; z-index: 9999; }
    </style>
</head>
<body>

    <div id="toast"></div>

    <!-- Login -->
    <div id="auth-screen">
        <div class="auth-card">
            <h1>ENTERPRISE</h1>
            <p style="margin-bottom: 30px;">SISTEMA DE GEST√ÉO V10.2</p>
            <button class="btn btn-p" onclick="entrar()">ENTRAR NO SISTEMA</button>
        </div>
    </div>

    <nav id="navbar">
        <div onclick="tab('os')" id="m-os" class="active"><i>üìÑ</i>Venda</div>
        <div onclick="tab('cli')" id="m-cli"><i>üë•</i>Clientes</div>
        <div onclick="tab('srv')" id="m-srv"><i>üì¶</i>Itens</div>
        <div onclick="tab('cfg')" id="m-cfg"><i>‚öôÔ∏è</i>Empresa</div>
    </nav>

    <main id="app">
        <!-- Vendas -->
        <section id="sec-os">
            <div class="card">
                <h2>Gerar Novo Or√ßamento</h2>
                <div class="field-group">
                    <label>Selecionar Cliente</label>
                    <select id="os-cliente"></select>
                </div>
                
                <div style="background: #f8fafc; padding: 15px; border-radius: 10px; border: 1px solid #e2e8f0; margin-bottom: 15px;">
                    <label>Adicionar Itens</label>
                    <div class="field-group">
                        <select id="os-item-add" onchange="atualizaPrecoUnitario()"></select>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" id="os-item-val" placeholder="Pre√ßo R$">
                        <button class="btn btn-p" onclick="addItem()" style="width: 50px;">+</button>
                    </div>
                </div>

                <div id="lista-carrinho"></div>

                <div style="text-align: right; margin-top: 20px;">
                    <p>Total Geral</p>
                    <h1 id="total-venda" style="color: var(--p); font-size: 28px;">R$ 0,00</h1>
                    <button class="btn btn-s" onclick="visualizarPDF()" style="margin-top: 15px;">GERAR DOCUMENTO A4</button>
                </div>
            </div>
        </section>

        <!-- Configura√ß√£o Empresa -->
        <section id="sec-cfg" style="display:none">
            <div class="card">
                <h2>Dados do Emitente (Sua Empresa)</h2>
                <div class="field-group"><label>Nome Fantasia</label><input id="cfg-nome"></div>
                <div class="field-group"><label>CNPJ / CPF</label><input id="cfg-doc"></div>
                <div class="field-group"><label>Endere√ßo</label><input id="cfg-end"></div>
                <div class="field-group"><label>Contato/WhatsApp</label><input id="cfg-tel"></div>
                <button class="btn btn-p" onclick="salvarConfig()">SALVAR DADOS</button>
            </div>
        </section>

        <!-- Cadastro Clientes -->
        <section id="sec-cli" style="display:none">
            <div class="card">
                <h2>Novo Cliente</h2>
                <div class="field-group"><label>Nome / Raz√£o Social</label><input id="cli-nome"></div>
                <div class="field-group"><label>CNPJ / CPF</label><input id="cli-doc"></div>
                <div class="field-group"><label>Endere√ßo Completo</label><input id="cli-end"></div>
                <div class="field-group"><label>Telefone</label><input id="cli-tel"></div>
                <button class="btn btn-p" onclick="salvarCliente()">CADASTRAR</button>
            </div>
            <div id="lista-clientes"></div>
        </section>

        <!-- Itens -->
        <section id="sec-srv" style="display:none">
            <div class="card">
                <h2>Novo Produto/Servi√ßo</h2>
                <div class="field-group"><label>Descri√ß√£o</label><input id="srv-nome"></div>
                <div class="field-group"><label>Pre√ßo Sugerido</label><input id="srv-preco" type="number"></div>
                <button class="btn btn-p" onclick="salvarProduto()">ADICIONAR</button>
            </div>
            <div id="lista-produtos"></div>
        </section>
    </main>

    <!-- Modal PDF -->
    <div id="modal-pdf" class="overlay">
        <div class="modal">
            <div id="preview-container">
                <!-- PDF Injetado Aqui -->
            </div>
            <div style="padding: 15px; background: white; display: flex; gap: 10px;">
                <button class="btn" onclick="fecharModal()" style="background: #ddd;">FECHAR</button>
                <button class="btn btn-p" onclick="baixarPDF()">BAIXAR PDF AGORA</button>
            </div>
        </div>
    </div>

    <script>
        const state = { carrinho: [], db: null, clientesRaw: [] };

        const initDB = () => {
            const request = indexedDB.open("EnterpriseDB", 4);
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains("clientes")) db.createObjectStore("clientes", { keyPath: "id", autoIncrement: true });
                if (!db.objectStoreNames.contains("produtos")) db.createObjectStore("produtos", { keyPath: "id", autoIncrement: true });
                if (!db.objectStoreNames.contains("config")) db.createObjectStore("config", { keyPath: "id" });
            };
            request.onsuccess = (e) => { state.db = e.target.result; carregarTudo(); };
        };

        const carregarTudo = () => { listarClientes(); listarProdutos(); carregarConfig(); };

        const listarClientes = () => {
            state.db.transaction("clientes").objectStore("clientes").getAll().onsuccess = (e) => {
                state.clientesRaw = e.target.result;
                document.getElementById('os-cliente').innerHTML = '<option value="">Escolha o cliente</option>' + 
                    state.clientesRaw.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
                document.getElementById('lista-clientes').innerHTML = state.clientesRaw.map(c => `
                    <div class="card" style="padding:10px; margin-bottom:5px; border-left:4px solid var(--p)">
                        <b>${c.nome}</b><br><small>${c.doc || 'Sem CNPJ'} | ${c.tel || ''}</small>
                    </div>
                `).join('');
            };
        };

        const listarProdutos = () => {
            state.db.transaction("produtos").objectStore("produtos").getAll().onsuccess = (e) => {
                const data = e.target.result;
                document.getElementById('os-item-add').innerHTML = '<option value="">Escolha o item</option>' + 
                    data.map(p => `<option value="${p.nome}" data-preco="${p.preco}">${p.nome}</option>`).join('');
                document.getElementById('lista-produtos').innerHTML = data.map(p => `
                    <div class="card" style="padding:10px; margin-bottom:5px; display:flex; justify-content:space-between">
                        <span>${p.nome}</span><b>R$ ${parseFloat(p.preco).toFixed(2)}</b>
                    </div>
                `).join('');
            };
        };

        const carregarConfig = () => {
            state.db.transaction("config").objectStore("config").get(1).onsuccess = (e) => {
                const c = e.target.result;
                if (c) {
                    document.getElementById('cfg-nome').value = c.nome || '';
                    document.getElementById('cfg-doc').value = c.doc || '';
                    document.getElementById('cfg-end').value = c.end || '';
                    document.getElementById('cfg-tel').value = c.tel || '';
                }
            };
        };

        const salvarConfig = () => {
            const d = { id: 1, nome: document.getElementById('cfg-nome').value, doc: document.getElementById('cfg-doc').value, end: document.getElementById('cfg-end').value, tel: document.getElementById('cfg-tel').value };
            state.db.transaction("config", "readwrite").objectStore("config").put(d).onsuccess = () => toast("Empresa salva!");
        };

        const salvarCliente = () => {
            const c = { nome: document.getElementById('cli-nome').value, doc: document.getElementById('cli-doc').value, tel: document.getElementById('cli-tel').value, end: document.getElementById('cli-end').value };
            if (!c.nome) return toast("Nome obrigat√≥rio");
            state.db.transaction("clientes", "readwrite").objectStore("clientes").add(c).onsuccess = () => {
                ['cli-nome', 'cli-doc', 'cli-tel', 'cli-end'].forEach(i => document.getElementById(i).value = '');
                listarClientes(); toast("Cliente salvo!");
            };
        };

        const salvarProduto = () => {
            const nome = document.getElementById('srv-nome').value;
            const preco = parseFloat(document.getElementById('srv-preco').value);
            state.db.transaction("produtos", "readwrite").objectStore("produtos").add({ nome, preco }).onsuccess = () => {
                document.getElementById('srv-nome').value = ''; document.getElementById('srv-preco').value = '';
                listarProdutos(); toast("Item salvo!");
            };
        };

        const atualizaPrecoUnitario = () => {
            const sel = document.getElementById('os-item-add');
            document.getElementById('os-item-val').value = sel.options[sel.selectedIndex].dataset.preco || '';
        };

        const addItem = () => {
            const nome = document.getElementById('os-item-add').value;
            const preco = parseFloat(document.getElementById('os-item-val').value);
            if (!nome || isNaN(preco)) return;
            state.carrinho.push({ nome, preco });
            renderCarrinho();
        };

        const renderCarrinho = () => {
            const container = document.getElementById('lista-carrinho');
            container.innerHTML = state.carrinho.map((item, idx) => `
                <div class="item-row">
                    <span>${item.nome}</span>
                    <b>R$ ${item.preco.toFixed(2)} <span onclick="removeItem(${idx})" style="color:red; cursor:pointer; margin-left:10px">‚úï</span></b>
                </div>
            `).join('');
            const total = state.carrinho.reduce((acc, cur) => acc + cur.preco, 0);
            document.getElementById('total-venda').innerText = `R$ ${total.toFixed(2)}`;
        };

        const removeItem = (idx) => { state.carrinho.splice(idx, 1); renderCarrinho(); };

        const visualizarPDF = () => {
            const cliId = document.getElementById('os-cliente').value;
            if (!cliId || state.carrinho.length === 0) return toast("Selecione cliente e itens!");

            const cliente = state.clientesRaw.find(c => c.id == cliId);
            
            state.db.transaction("config").objectStore("config").get(1).onsuccess = (e) => {
                const cfg = e.target.result || { nome: "EMPRESA EXEMPLO", doc: "00.000.000/0001-00", end: "Rua Exemplo, 123", tel: "(00) 00000-0000" };
                const total = state.carrinho.reduce((acc, cur) => acc + cur.preco, 0);
                const data = new Date().toLocaleDateString('pt-BR');

                const html = `
                    <div class="pdf-page" id="folha-a4">
                        <div class="pdf-header">
                            <div class="empresa-info">
                                <h1>${cfg.nome}</h1>
                                <p><b>CNPJ/CPF:</b> ${cfg.doc}</p>
                                <p><b>ENDERE√áO:</b> ${cfg.end}</p>
                                <p><b>CONTATO:</b> ${cfg.tel}</p>
                            </div>
                            <div class="doc-tipo">
                                <div class="badge">OR√áAMENTO</div>
                                <p>Data: ${data}</p>
                                <p>Doc: #${Math.floor(Date.now()/100000)}</p>
                            </div>
                        </div>

                        <div class="cliente-box">
                            <h3>Dados do Cliente</h3>
                            <div><b>Nome / Raz√£o Social</b><p>${cliente.nome}</p></div>
                            <div><b>CNPJ / CPF</b><p>${cliente.doc || '---'}</p></div>
                            <div><b>Endere√ßo</b><p>${cliente.end || '---'}</p></div>
                            <div><b>Telefone</b><p>${cliente.tel || '---'}</p></div>
                        </div>

                        <table class="tabela-pdf">
                            <thead>
                                <tr>
                                    <th style="width:70%">Descri√ß√£o dos Itens / Servi√ßos</th>
                                    <th style="width:10%">Qtd</th>
                                    <th style="width:20%; text-align:right">Valor</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${state.carrinho.map(i => `
                                    <tr>
                                        <td>${i.nome}</td>
                                        <td>1</td>
                                        <td style="text-align:right">R$ ${i.preco.toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>

                        <div class="total-pdf">
                            <p style="font-size:12px; color:#64748b">VALOR TOTAL DA PROPOSTA</p>
                            <h2>R$ ${total.toFixed(2)}</h2>
                        </div>

                        <div class="footer-pdf">
                            Este documento √© uma proposta comercial. Gerado por Enterprise ERP.
                        </div>
                    </div>
                `;

                document.getElementById('preview-container').innerHTML = html;
                document.getElementById('modal-pdf').style.display = 'flex';
            };
        };

        const baixarPDF = () => {
            const element = document.getElementById('folha-a4');
            
            // Configura√ß√µes otimizadas para evitar quebras
            const opt = {
                margin: 0,
                filename: 'Orcamento.pdf',
                image: { type: 'jpeg', quality: 1 },
                html2canvas: { 
                    scale: 2, 
                    useCORS: true,
                    logging: false,
                    letterRendering: true,
                    scrollY: 0,
                    windowWidth: 1200 // Simula largura de desktop para o canvas
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            toast("Processando PDF...");
            
            // Pequeno delay para garantir que o DOM est√° est√°vel
            setTimeout(() => {
                html2pdf().set(opt).from(element).save().then(() => {
                    fecharModal();
                    toast("Download conclu√≠do!");
                });
            }, 500);
        };

        const tab = (t) => {
            document.querySelectorAll('section').forEach(s => s.style.display = 'none');
            document.querySelectorAll('nav div').forEach(d => d.classList.remove('active'));
            document.getElementById(`sec-${t}`).style.display = 'block';
            document.getElementById(`m-${t}`).classList.add('active');
        };

        const entrar = () => {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('navbar').style.display = 'grid';
            document.getElementById('app').style.display = 'block';
            initDB();
        };

        const fecharModal = () => document.getElementById('modal-pdf').style.display = 'none';
        const toast = (m) => { const t = document.getElementById('toast'); t.innerText = m; t.style.display = 'block'; setTimeout(()=>t.style.display='none', 2000); };
    </script>
</body>
</html>
