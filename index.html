<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ENTERPRISE ERP V10.9</title>
    
    <!-- Bibliotecas Necess√°rias -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root {
            --primary: #1e40af;
            --secondary: #10b981;
            --danger: #ef4444;
            --background: #f1f5f9;
            --surface: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', system-ui, sans-serif; }
        
        body { background: var(--background); color: var(--text-main); font-size: 14px; line-height: 1.5; -webkit-tap-highlight-color: transparent; }

        /* Login Screen */
        #auth-screen { position: fixed; inset: 0; z-index: 10000; background: #0f172a; display: flex; align-items: center; justify-content: center; color: white; }
        .auth-container { text-align: center; width: 100%; max-width: 320px; padding: 20px; }
        .logo-large { font-size: 32px; font-weight: 900; letter-spacing: -1px; margin-bottom: 8px; color: #60a5fa; }
        .auth-card { background: rgba(255,255,255,0.05); padding: 24px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); }
        .auth-input { width: 100%; padding: 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.2); color: white; text-align: center; font-size: 18px; letter-spacing: 4px; margin-bottom: 15px; outline: none; }

        /* Navigation */
        nav { position: fixed; bottom: 0; width: 100%; background: #ffffff; display: none; grid-template-columns: repeat(4, 1fr); padding: 10px 0; z-index: 1000; border-top: 1px solid var(--border); padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
        nav div { color: #94a3b8; font-size: 11px; text-align: center; cursor: pointer; }
        nav div i { display: block; font-size: 20px; margin-bottom: 4px; font-style: normal; }
        nav div.active { color: var(--primary); font-weight: bold; }

        /* Layout */
        main { padding: 16px; max-width: 850px; margin: 0 auto 100px auto; display: none; }
        .section-title { font-size: 20px; font-weight: 800; margin-bottom: 16px; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
        
        /* UI Components */
        .card { background: var(--surface); border-radius: 12px; padding: 16px; border: 1px solid var(--border); margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .form-group { margin-bottom: 14px; }
        label { display: block; font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: #f8fafc; font-size: 14px; color: var(--text-main); outline: none; }
        input:focus { border-color: var(--primary); background: #fff; }
        
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 12px 20px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; font-size: 14px; gap: 8px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-success { background: var(--secondary); color: white; width: 100%; }
        .btn-danger-sm { background: #fef2f2; color: var(--danger); padding: 6px 10px; font-size: 11px; border-radius: 6px; border: 1px solid #fee2e2; }

        .list-item { padding: 12px; background: #f8fafc; border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--border); position: relative; }
        .remove-btn { position: absolute; top: 12px; right: 12px; cursor: pointer; color: var(--danger); font-size: 18px; font-weight: bold; }

        /* Modal Preview */
        #modal-preview { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 5000; display: none; flex-direction: column; }
        #modal-header { background: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        #preview-body { flex: 1; overflow-y: auto; padding: 20px; display: flex; justify-content: center; background: #334155; }
        
        /* PDF Template */
        .pdf-page { width: 210mm; min-height: 297mm; background: white; padding: 15mm; color: #000; font-size: 11pt; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .pdf-header { display: flex; justify-content: space-between; border-bottom: 3px solid #1e40af; padding-bottom: 15px; margin-bottom: 20px; align-items: center; }
        .pdf-logo { max-width: 180px; max-height: 90px; object-fit: contain; }
        .pdf-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .pdf-table th { background: #f1f5f9; color: #1e40af; text-align: left; padding: 10px; font-size: 9pt; border-bottom: 2px solid #cbd5e1; }
        .pdf-table td { padding: 10px; border-bottom: 1px solid #e2e8f0; vertical-align: top; }

        #toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 10px 20px; border-radius: 8px; z-index: 11000; display: none; font-size: 13px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        
        .img-preview-box { width: 100%; height: 150px; border: 2px dashed var(--border); border-radius: 12px; display: flex; align-items: center; justify-content: center; overflow: hidden; margin: 10px 0; background: #f8fafc; cursor: pointer; }
        .img-preview-box img { max-width: 100%; max-height: 100%; }
    </style>
</head>
<body onload="auth.check()">

    <div id="toast"></div>

    <!-- Tela de Login -->
    <div id="auth-screen">
        <div class="auth-container">
            <div class="logo-large">ENTERPRISE</div>
            <div class="auth-card" id="auth-card">Processando...</div>
        </div>
    </div>

    <!-- Navega√ß√£o -->
    <nav id="main-nav">
        <div onclick="ui.tab('vendas')" id="tab-vendas" class="active"><i>üìã</i>Or√ßar</div>
        <div onclick="ui.tab('clientes')" id="tab-clientes"><i>üë•</i>Clientes</div>
        <div onclick="ui.tab('itens')" id="tab-itens"><i>üì¶</i>Produtos</div>
        <div onclick="ui.tab('config')" id="tab-config"><i>‚öôÔ∏è</i>Empresa</div>
    </nav>

    <main id="main-app">
        
        <!-- ABA: VENDAS -->
        <section id="sec-vendas">
            <div class="section-title">Gerar Or√ßamento</div>
            <div class="card">
                <div class="form-group">
                    <label>Cliente</label>
                    <select id="venda-cliente"></select>
                </div>
                
                <div style="background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 15px;">
                    <label>Adicionar Produto/Servi√ßo</label>
                    <select id="venda-item-select" onchange="ui.autoPreco()" style="margin-bottom: 10px;"></select>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="form-group">
                            <label>Pre√ßo Unit√°rio</label>
                            <input type="number" id="venda-item-preco" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Quantidade</label>
                            <input type="number" id="venda-item-qtd" value="1" step="0.1">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Observa√ß√£o T√©cnica (Ex: Medidas, Material)</label>
                        <input type="text" id="venda-item-obs" placeholder="Detalhes espec√≠ficos deste item...">
                    </div>
                    
                    <button class="btn btn-primary" onclick="app.addItem()">INCLUIR NO OR√áAMENTO</button>
                </div>

                <div id="carrinho-lista"></div>

                <div style="margin-top: 20px; border-top: 2px solid var(--background); padding-top: 15px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="form-group">
                            <label>Validade (Dias)</label>
                            <input type="number" id="venda-validade" value="7">
                        </div>
                        <div class="form-group">
                            <label>N¬∫ do Or√ßamento</label>
                            <input type="text" id="venda-manual-ref" placeholder="Autom√°tico">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Condi√ß√µes e Observa√ß√µes Gerais</label>
                        <textarea id="venda-notas" rows="2" placeholder="Ex: Pagamento 50% ato, 50% entrega."></textarea>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin: 15px 0;">
                        <span style="font-weight: bold; color: var(--text-muted);">VALOR TOTAL:</span>
                        <h2 id="venda-total" style="color: var(--primary);">R$ 0,00</h2>
                    </div>
                    <button class="btn btn-success" onclick="app.preparePDF()" style="height: 60px; font-size: 16px;">VISUALIZAR E GERAR PDF</button>
                </div>
            </div>
        </section>

        <!-- ABA: CLIENTES -->
        <section id="sec-clientes" style="display:none">
            <div class="section-title">Clientes</div>
            <div class="card">
                <div class="form-group"><label>Nome / Empresa</label><input id="cli-nome"></div>
                <div class="form-group"><label>CPF / CNPJ</label><input id="cli-doc"></div>
                <div class="form-group"><label>WhatsApp / Tel</label><input id="cli-tel"></div>
                <button class="btn btn-primary" onclick="app.saveCliente()">SALVAR CLIENTE</button>
            </div>
            <div id="lista-clientes-cad"></div>
        </section>

        <!-- ABA: PRODUTOS -->
        <section id="sec-itens" style="display:none">
            <div class="section-title">Produtos e Servi√ßos</div>
            <div class="card">
                <div class="form-group"><label>Descri√ß√£o do Item</label><input id="item-nome"></div>
                <div class="form-group">
                    <label>Unidade de Medida</label>
                    <select id="item-unid">
                        <option value="Unid.">Unidade</option>
                        <option value="Mts">Metros (Lin)</option>
                        <option value="M2">M2 (Quadrado)</option>
                        <option value="Kg">Quilos</option>
                        <option value="Servi√ßo">Servi√ßo/M√£o de Obra</option>
                    </select>
                </div>
                <div class="form-group"><label>Pre√ßo Base (R$)</label><input id="item-preco" type="number" step="0.01"></div>
                <button class="btn btn-primary" onclick="app.saveProduto()">ADICIONAR AO CAT√ÅLOGO</button>
            </div>
            <div id="lista-produtos-cad"></div>
        </section>

        <!-- ABA: EMPRESA -->
        <section id="sec-config" style="display:none">
            <div class="section-title">Configura√ß√µes da Empresa</div>
            <div class="card">
                <label>Logo da Empresa (Clique para alterar)</label>
                <div class="img-preview-box" onclick="document.getElementById('cfg-logo-input').click()" id="logo-preview-container">
                    <span>Clique para carregar imagem</span>
                </div>
                <input type="file" id="cfg-logo-input" accept="image/*" style="display:none" onchange="ui.previewLogo(this)">
                
                <div class="form-group"><label>Nome Fantasia</label><input id="cfg-nome"></div>
                <div class="form-group"><label>CNPJ ou CPF</label><input id="cfg-doc"></div>
                <div class="form-group"><label>Telefone / WhatsApp</label><input id="cfg-tel"></div>
                <div class="form-group"><label>Endere√ßo Completo</label><input id="cfg-end"></div>
                <button class="btn btn-primary" onclick="app.saveConfig()">ATUALIZAR DADOS</button>
            </div>
            <div style="text-align: center; margin: 30px 0;">
                <p style="font-size: 11px; color: var(--text-muted); margin-bottom: 10px;">Vers√£o 10.9 Pro - Armazenamento Local</p>
                <button onclick="if(confirm('Apagar tudo?')) { localStorage.clear(); location.reload(); }" style="color: var(--danger); background: none; border: none; font-size: 11px; text-decoration: underline;">Limpar Mem√≥ria do Sistema</button>
            </div>
        </section>
    </main>

    <!-- MODAL PDF -->
    <div id="modal-preview">
        <div id="modal-header">
            <h3>Pr√©-visualiza√ß√£o do Documento</h3>
            <button onclick="ui.closeModal()" style="font-size: 30px; border:none; background:none;">&times;</button>
        </div>
        <div id="preview-body"></div>
        <div style="padding: 15px 20px; background: white; border-top: 1px solid var(--border);">
            <button class="btn btn-success" onclick="app.downloadPDF()" style="width: 100%; height: 50px;">BAIXAR PDF AGORA</button>
        </div>
    </div>

    <!-- Ponte de Renderiza√ß√£o Invis√≠vel -->
    <div id="render-bridge" style="position: absolute; left: -9999px; top: 0; width: 210mm;"></div>

    <script>
        const auth = {
            key: "enterprise_v109_key",
            check() {
                const s = localStorage.getItem(this.key);
                const c = document.getElementById('auth-card');
                if(!s) {
                    c.innerHTML = `<h3>Novo Acesso</h3><p style="margin:10px 0; font-size:12px">Crie sua senha de acesso.</p><input type="password" id="np" class="auth-input"><button class="btn btn-primary" onclick="auth.create()">CRIAR</button>`;
                } else {
                    c.innerHTML = `<h3>Login</h3><p style="margin:10px 0; font-size:12px">Digite sua senha.</p><input type="password" id="lp" class="auth-input" autofocus><button class="btn btn-primary" onclick="auth.login()">ENTRAR</button>`;
                    document.getElementById('lp').addEventListener('keyup', (e) => { if(e.key === 'Enter') this.login(); });
                }
            },
            create() { const p = document.getElementById('np').value; if(p) { localStorage.setItem(this.key, p); this.enter(); } },
            login() { if(document.getElementById('lp').value === localStorage.getItem(this.key)) this.enter(); else ui.toast("Senha incorreta"); },
            enter() {
                document.getElementById('auth-screen').style.display='none';
                document.getElementById('main-nav').style.display='grid';
                document.getElementById('main-app').style.display='block';
                app.initDB();
            }
        };

        const app = {
            db: null, carrinho: [], clientes: [], produtos: [], config: {},

            initDB() {
                const req = indexedDB.open("Enterprise_Final_DB", 2);
                req.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if(!db.objectStoreNames.contains("clientes")) db.createObjectStore("clientes", { keyPath: "id", autoIncrement: true });
                    if(!db.objectStoreNames.contains("produtos")) db.createObjectStore("produtos", { keyPath: "id", autoIncrement: true });
                    if(!db.objectStoreNames.contains("config")) db.createObjectStore("config", { keyPath: "id" });
                };
                req.onsuccess = (e) => { this.db = e.target.result; this.loadAll(); };
            },

            loadAll() {
                const tx = this.db.transaction(["clientes", "produtos", "config"], "readonly");
                tx.objectStore("clientes").getAll().onsuccess = (e) => { this.clientes = e.target.result; ui.renderClientes(); };
                tx.objectStore("produtos").getAll().onsuccess = (e) => { this.produtos = e.target.result; ui.renderProdutos(); };
                tx.objectStore("config").get(1).onsuccess = (e) => { 
                    if(e.target.result) { this.config = e.target.result; ui.fillConfig(); }
                };
            },

            saveConfig() {
                const d = { 
                    id: 1, 
                    nome: document.getElementById('cfg-nome').value, 
                    doc: document.getElementById('cfg-doc').value, 
                    tel: document.getElementById('cfg-tel').value,
                    end: document.getElementById('cfg-end').value,
                    logo: this.tempLogo || this.config.logo || ""
                };
                this.db.transaction("config", "readwrite").objectStore("config").put(d).onsuccess = () => { 
                    this.config = d; ui.toast("Empresa Atualizada!"); 
                };
            },

            saveCliente() {
                const c = { nome: document.getElementById('cli-nome').value, doc: document.getElementById('cli-doc').value, tel: document.getElementById('cli-tel').value };
                if(!c.nome) return ui.toast("Nome √© obrigat√≥rio");
                this.db.transaction("clientes", "readwrite").objectStore("clientes").add(c).onsuccess = () => { 
                    this.loadAll(); document.getElementById('cli-nome').value=''; document.getElementById('cli-doc').value=''; document.getElementById('cli-tel').value='';
                    ui.toast("Cliente salvo");
                };
            },

            deleteCliente(id) { if(confirm("Remover cliente?")) this.db.transaction("clientes", "readwrite").objectStore("clientes").delete(id).onsuccess = () => this.loadAll(); },

            saveProduto() {
                const p = { nome: document.getElementById('item-nome').value, preco: parseFloat(document.getElementById('item-preco').value) || 0, unid: document.getElementById('item-unid').value };
                if(!p.nome) return ui.toast("Nome do produto obrigat√≥rio");
                this.db.transaction("produtos", "readwrite").objectStore("produtos").add(p).onsuccess = () => { 
                    this.loadAll(); document.getElementById('item-nome').value=''; document.getElementById('item-preco').value='';
                    ui.toast("Produto salvo"); 
                };
            },

            deleteProduto(id) { if(confirm("Remover produto?")) this.db.transaction("produtos", "readwrite").objectStore("produtos").delete(id).onsuccess = () => this.loadAll(); },

            addItem() {
                const sel = document.getElementById('venda-item-select');
                const opt = sel.options[sel.selectedIndex];
                const p = { 
                    nome: sel.value, 
                    obs: document.getElementById('venda-item-obs').value,
                    preco: parseFloat(document.getElementById('venda-item-preco').value) || 0,
                    qtd: parseFloat(document.getElementById('venda-item-qtd').value) || 1,
                    unid: opt.dataset.u || 'Unid.'
                };
                if(!p.nome) return ui.toast("Selecione um item");
                this.carrinho.push(p);
                ui.renderCarrinho();
                document.getElementById('venda-item-obs').value = '';
            },

            removeItem(i) { this.carrinho.splice(i, 1); ui.renderCarrinho(); },

            preparePDF() {
                const cliId = document.getElementById('venda-cliente').value;
                const cli = this.clientes.find(c => c.id == cliId);
                if(!cli) return ui.toast("Selecione um cliente primeiro");
                if(!this.carrinho.length) return ui.toast("Adicione produtos ao or√ßamento");
                
                const total = this.carrinho.reduce((a, b) => a + (b.preco * b.qtd), 0);
                const ref = document.getElementById('venda-manual-ref').value || Math.floor(Date.now()/1000);
                const validade = document.getElementById('venda-validade').value || '7';
                const notas = document.getElementById('venda-notas').value || 'Pagamento conforme acordado.';

                const html = `
                    <div class="pdf-page" id="doc-pdf">
                        <div class="pdf-header">
                            <div style="flex:1">
                                ${this.config.logo ? `<img src="${this.config.logo}" class="pdf-logo">` : `<h2 style="color:#1e40af">${this.config.nome || 'EMPRESA N√ÉO CONFIGURADA'}</h2>`}
                                <div style="font-size:9pt; color:#475569; margin-top:10px; line-height:1.4">
                                    <p><b>${this.config.nome || 'Favor configurar dados da empresa'}</b></p>
                                    <p>CNPJ/CPF: ${this.config.doc || '-'}</p>
                                    <p>Telefone: ${this.config.tel || '-'}</p>
                                    <p>${this.config.end || '-'}</p>
                                </div>
                            </div>
                            <div style="text-align:right">
                                <h1 style="color:#1e40af; font-size:24pt; margin:0">OR√áAMENTO</h1>
                                <p style="font-size:10pt; color:#64748b">Ref: #${ref}</p>
                                <p style="font-size:10pt; font-weight:bold; margin-top:5px">Data: ${new Date().toLocaleDateString('pt-BR')}</p>
                            </div>
                        </div>

                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px">
                            <div style="background:#f8fafc; padding:15px; border-radius:10px; border:1px solid #e2e8f0">
                                <p style="font-size:8pt; color:#64748b; text-transform:uppercase; margin-bottom:5px">Dados do Cliente</p>
                                <p style="font-size:12pt; font-weight:bold; color:#1e293b">${cli.nome}</p>
                                <p style="font-size:10pt; color:#475569">Doc: ${cli.doc || 'N√£o informado'}</p>
                                <p style="font-size:10pt; color:#475569">Tel: ${cli.tel || '-'}</p>
                            </div>
                            <div style="background:#f8fafc; padding:15px; border-radius:10px; border:1px solid #e2e8f0; text-align:right">
                                <p style="font-size:8pt; color:#64748b; text-transform:uppercase; margin-bottom:5px">Validade da Proposta</p>
                                <p style="font-size:14pt; font-weight:bold; color:#1e293b">${validade} Dias</p>
                                <p style="font-size:9pt; color:#64748b">A contar da data de emiss√£o</p>
                            </div>
                        </div>

                        <table class="pdf-table">
                            <thead>
                                <tr>
                                    <th style="width:55%">Descri√ß√£o Detalhada do Item / Servi√ßo</th>
                                    <th>Qtd.</th>
                                    <th>P. Unit.</th>
                                    <th style="text-align:right">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${this.carrinho.map(it => `
                                    <tr>
                                        <td>
                                            <div style="font-weight:bold; color:#1e293b">${it.nome}</div>
                                            <div style="font-size:8.5pt; color:#64748b; margin-top:3px">${it.obs || ''}</div>
                                        </td>
                                        <td style="font-size:10pt">${it.qtd} ${it.unid}</td>
                                        <td style="font-size:10pt">R$ ${it.preco.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                                        <td style="text-align:right; font-weight:bold; color:#1e293b">R$ ${(it.preco * it.qtd).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                                    </tr>`).join('')}
                            </tbody>
                        </table>

                        <div style="display:flex; justify-content: space-between; align-items: flex-start; margin-top:30px">
                            <div style="max-width:60%">
                                <p style="font-size:8pt; color:#64748b; text-transform:uppercase; margin-bottom:8px">Observa√ß√µes T√©cnicas e Pagamento</p>
                                <div style="font-size:10pt; color:#475569; background:#f8fafc; padding:10px; border-radius:8px; border-left:4px solid #cbd5e1">
                                    ${notas.replace(/\n/g, '<br>')}
                                </div>
                            </div>
                            <div style="text-align:right; min-width:200px">
                                <p style="font-size:11pt; color:#64748b; margin-bottom:5px">VALOR TOTAL</p>
                                <div style="background:#1e40af; color:white; padding:15px; border-radius:10px">
                                    <span style="font-size:10pt">R$</span> 
                                    <span style="font-size:22pt; font-weight:900">${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top:80px; text-align:center;">
                            <div style="width:250px; border-top:1px solid #94a3b8; margin:0 auto; padding-top:10px">
                                <p style="font-size:9pt; font-weight:bold">${this.config.nome || 'Assinatura do Respons√°vel'}</p>
                                <p style="font-size:8pt; color:#64748b">Respons√°vel pela Proposta</p>
                            </div>
                        </div>

                        <div style="position:absolute; bottom:15mm; left:15mm; right:15mm; text-align:center; font-size:8pt; color:#94a3b8; border-top:1px solid #f1f5f9; padding-top:10px">
                            Este documento √© uma proposta comercial e n√£o tem valor de nota fiscal.
                        </div>
                    </div>
                `;
                document.getElementById('preview-body').innerHTML = html;
                document.getElementById('modal-preview').style.display='flex';
            },

            downloadPDF() {
                const el = document.getElementById('doc-pdf');
                const bridge = document.getElementById('render-bridge');
                bridge.innerHTML = el.outerHTML;
                
                // Op√ß√µes otimizadas para PDF m√≥vel e Desktop
                const opt = { 
                    margin: 0, 
                    filename: `Orcamento_${Date.now()}.pdf`, 
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true, letterRendering: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } 
                };
                
                ui.toast("Gerando PDF... Aguarde.");
                html2pdf().set(opt).from(bridge.firstChild).save().then(() => {
                    ui.closeModal();
                    ui.toast("PDF gerado com sucesso!");
                });
            }
        };

        const ui = {
            tempLogo: null,
            tab(t) {
                document.querySelectorAll('main section').forEach(s => s.style.display='none');
                document.querySelectorAll('nav div').forEach(d => d.classList.remove('active'));
                document.getElementById('sec-'+t).style.display='block';
                document.getElementById('tab-'+t).classList.add('active');
            },
            toast(m) { 
                const t=document.getElementById('toast'); t.innerText=m; t.style.display='block'; 
                setTimeout(()=>t.style.display='none',3000);
            },
            previewLogo(input) {
                if (input.files && input.files[0]) {
                    const r = new FileReader();
                    r.onload = (e) => {
                        app.tempLogo = e.target.result;
                        document.getElementById('logo-preview-container').innerHTML = `<img src="${e.target.result}">`;
                    };
                    r.readAsDataURL(input.files[0]);
                }
            },
            fillConfig() {
                document.getElementById('cfg-nome').value = app.config.nome || '';
                document.getElementById('cfg-doc').value = app.config.doc || '';
                document.getElementById('cfg-tel').value = app.config.tel || '';
                document.getElementById('cfg-end').value = app.config.end || '';
                if(app.config.logo) {
                    document.getElementById('logo-preview-container').innerHTML = `<img src="${app.config.logo}">`;
                }
            },
            renderClientes() {
                const s = document.getElementById('venda-cliente');
                s.innerHTML = '<option value="">Selecionar Cliente...</option>' + app.clientes.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
                document.getElementById('lista-clientes-cad').innerHTML = app.clientes.map(c => `
                    <div class="list-item">
                        <div class="remove-btn" onclick="app.deleteCliente(${c.id})">&times;</div>
                        <b>${c.nome}</b><br><small>${c.doc || ''} | ${c.tel || ''}</small>
                    </div>`).join('');
            },
            renderProdutos() {
                const s = document.getElementById('venda-item-select');
                s.innerHTML = '<option value="">Escolher Item do Cat√°logo...</option>' + app.produtos.map(p => `<option value="${p.nome}" data-p="${p.preco}" data-u="${p.unid}">${p.nome}</option>`).join('');
                document.getElementById('lista-produtos-cad').innerHTML = app.produtos.map(p => `
                    <div class="list-item">
                        <div class="remove-btn" onclick="app.deleteProduto(${p.id})">&times;</div>
                        <b>${p.nome}</b><br><small>R$ ${p.preco.toFixed(2)} / ${p.unid}</small>
                    </div>`).join('');
            },
            autoPreco() {
                const s = document.getElementById('venda-item-select');
                const opt = s.options[s.selectedIndex];
                if(opt && opt.dataset.p) document.getElementById('venda-item-preco').value = opt.dataset.p;
            },
            renderCarrinho() {
                const c = document.getElementById('carrinho-lista');
                c.innerHTML = app.carrinho.map((it, i) => `
                    <div class="list-item" style="border-left:5px solid var(--primary)">
                        <div class="remove-btn" onclick="app.removeItem(${i})">&times;</div>
                        <div style="font-weight:bold; font-size:15px">${it.qtd} ${it.unid} x ${it.nome}</div>
                        <div style="font-size:12px; color:var(--text-muted)">${it.obs || 'Sem observa√ß√£o'}</div>
                        <div style="text-align:right; font-weight:bold; color:var(--primary)">Subtotal: R$ ${(it.preco*it.qtd).toLocaleString('pt-BR', {minimumFractionDigits:2})}</div>
                    </div>`).join('');
                const total = app.carrinho.reduce((a, b) => a + (b.preco * b.qtd), 0);
                document.getElementById('venda-total').innerText = "R$ " + total.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            },
            closeModal() { document.getElementById('modal-preview').style.display='none'; }
        };
    </script>
</body>
</html>
