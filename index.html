<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ENTERPRISE ERP V10.3</title>
    
    <!-- Bibliotecas de Renderiza√ß√£o -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root {
            --primary: #1e40af;
            --secondary: #10b981;
            --danger: #ef4444;
            --background: #f8fafc;
            --surface: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', 'Segoe UI', sans-serif; }
        
        body { background: var(--background); color: var(--text-main); font-size: 14px; line-height: 1.5; -webkit-tap-highlight-color: transparent; }

        /* Auth Screen */
        #auth-screen { position: fixed; inset: 0; z-index: 10000; background: #0f172a; display: flex; align-items: center; justify-content: center; color: white; }
        .auth-container { text-align: center; width: 100%; max-width: 320px; padding: 20px; }
        .logo-large { font-size: 32px; font-weight: 900; letter-spacing: -1px; margin-bottom: 8px; }

        /* Navigation */
        nav { position: fixed; bottom: 0; width: 100%; background: #0f172a; display: none; grid-template-columns: repeat(4, 1fr); padding: 10px 0; z-index: 1000; border-top: 1px solid rgba(255,255,255,0.1); padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
        nav div { color: #94a3b8; font-size: 11px; text-align: center; cursor: pointer; transition: 0.2s; }
        nav div i { display: block; font-size: 20px; margin-bottom: 4px; font-style: normal; }
        nav div.active { color: #60a5fa; font-weight: bold; }

        /* Layout */
        main { padding: 16px; max-width: 800px; margin: 0 auto 100px auto; display: none; }
        .section-title { font-size: 18px; font-weight: 800; margin-bottom: 16px; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
        
        /* Cards & UI */
        .card { background: var(--surface); border-radius: 12px; padding: 16px; border: 1px solid var(--border); margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .form-group { margin-bottom: 14px; }
        label { display: block; font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: #ffffff; font-size: 14px; color: var(--text-main); outline: none; transition: border 0.2s; }
        input:focus { border-color: var(--primary); }
        
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 12px 20px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; font-size: 14px; gap: 8px; transition: 0.2s; text-decoration: none; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-success { background: var(--secondary); color: white; width: 100%; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        .btn:active { transform: scale(0.98); opacity: 0.9; }

        /* Carrinho e Listas */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f1f5f9; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid var(--primary); }
        .remove-btn { color: var(--danger); font-weight: bold; cursor: pointer; padding: 5px; }

        /* MODAL PREVIEW */
        #modal-preview { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 5000; display: none; flex-direction: column; }
        #modal-header { background: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        #preview-body { flex: 1; overflow-y: auto; padding: 20px; display: flex; justify-content: center; background: #525659; }
        
        /* ESTILO DO DOCUMENTO PDF (A4 Real) */
        .pdf-page { 
            width: 210mm; 
            min-height: 297mm; 
            background: white; 
            padding: 20mm; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5); 
            color: #000; 
            position: relative;
        }

        /* Classes para o PDF */
        .pdf-header { display: flex; justify-content: space-between; border-bottom: 2px solid #1e40af; padding-bottom: 20px; margin-bottom: 30px; }
        .pdf-company h1 { color: #1e40af; font-size: 24pt; text-transform: uppercase; margin: 0; }
        .pdf-company p { font-size: 10pt; margin: 2px 0; color: #334155; }
        .pdf-meta { text-align: right; }
        .pdf-meta h2 { font-size: 18pt; color: #64748b; margin: 0; }
        
        .pdf-info-box { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .pdf-info-card { background: #f8fafc; padding: 15px; border-radius: 5px; border-top: 3px solid #1e40af; }
        .pdf-info-card h3 { font-size: 9pt; color: #64748b; text-transform: uppercase; margin-bottom: 5px; }
        .pdf-info-card p { font-size: 11pt; font-weight: bold; }

        .pdf-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
        .pdf-table th { background: #1e40af; color: white; text-align: left; padding: 12px; font-size: 10pt; }
        .pdf-table td { padding: 12px; border-bottom: 1px solid #e2e8f0; font-size: 10pt; }
        
        .pdf-total-container { display: flex; justify-content: flex-end; }
        .pdf-total-box { background: #1e40af; color: white; padding: 20px 40px; border-radius: 8px; text-align: right; }
        .pdf-total-label { font-size: 10pt; opacity: 0.8; }
        .pdf-total-value { font-size: 24pt; font-weight: 800; }

        .pdf-footer { position: absolute; bottom: 20mm; left: 20mm; right: 20mm; border-top: 1px solid #e2e8f0; padding-top: 10px; font-size: 8pt; color: #94a3b8; text-align: center; }

        /* Toast */
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 12px 24px; border-radius: 50px; font-size: 13px; z-index: 11000; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div id="toast">Notifica√ß√£o</div>

    <!-- Tela de Carregamento/Auth -->
    <div id="auth-screen">
        <div class="auth-container">
            <div class="logo-large">ENTERPRISE</div>
            <p style="opacity: 0.6; margin-bottom: 40px;">GEST√ÉO INTELIGENTE V10.3</p>
            <button class="btn btn-primary" onclick="app.init()">ACESSAR SISTEMA</button>
        </div>
    </div>

    <!-- Navega√ß√£o Inferior -->
    <nav id="main-nav">
        <div onclick="ui.tab('vendas')" id="tab-vendas" class="active"><i>üìÑ</i>Venda</div>
        <div onclick="ui.tab('clientes')" id="tab-clientes"><i>üë•</i>Clientes</div>
        <div onclick="ui.tab('itens')" id="tab-itens"><i>üì¶</i>Produtos</div>
        <div onclick="ui.tab('config')" id="tab-config"><i>‚öôÔ∏è</i>Perfil</div>
    </nav>

    <main id="main-app">
        <!-- Aba de Vendas -->
        <section id="sec-vendas">
            <div class="section-title">Gerar Or√ßamento</div>
            <div class="card">
                <div class="form-group">
                    <label>Cliente</label>
                    <select id="venda-cliente"></select>
                </div>
                
                <div style="background: #f1f5f9; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                    <label>Adicionar Item ao Or√ßamento</label>
                    <select id="venda-item-select" onchange="ui.autoPreco()"></select>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <input type="number" id="venda-item-preco" placeholder="R$ 0,00">
                        <button class="btn btn-primary" onclick="app.addItem()" style="width: 100px;">ADD</button>
                    </div>
                </div>

                <div id="carrinho-lista">
                    <p style="text-align: center; color: var(--text-muted); padding: 20px;">Nenhum item adicionado.</p>
                </div>

                <div style="margin-top: 20px; border-top: 2px solid var(--background); padding-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: bold; color: var(--text-muted);">TOTAL:</span>
                        <h1 id="venda-total" style="color: var(--primary);">R$ 0,00</h1>
                    </div>
                    <button class="btn btn-success" onclick="app.preparePDF()" style="margin-top: 20px; height: 60px; font-size: 16px;">
                        VISUALIZAR E GERAR PDF
                    </button>
                </div>
            </div>
        </section>

        <!-- Aba de Clientes -->
        <section id="sec-clientes" style="display:none">
            <div class="section-title">Clientes</div>
            <div class="card">
                <div class="form-group"><label>Nome Completo / Raz√£o</label><input id="cli-nome"></div>
                <div class="form-group"><label>CPF / CNPJ</label><input id="cli-doc"></div>
                <div class="form-group"><label>Telefone / WhatsApp</label><input id="cli-tel"></div>
                <button class="btn btn-primary" onclick="app.saveCliente()">SALVAR CLIENTE</button>
            </div>
            <div id="lista-clientes-cad"></div>
        </section>

        <!-- Aba de Itens -->
        <section id="sec-itens" style="display:none">
            <div class="section-title">Cat√°logo de Servi√ßos/Produtos</div>
            <div class="card">
                <div class="form-group"><label>Nome do Item</label><input id="item-nome"></div>
                <div class="form-group"><label>Pre√ßo Sugerido (R$)</label><input id="item-preco" type="number"></div>
                <button class="btn btn-primary" onclick="app.saveProduto()">SALVAR NO CAT√ÅLOGO</button>
            </div>
            <div id="lista-produtos-cad"></div>
        </section>

        <!-- Aba de Configura√ß√£o -->
        <section id="sec-config" style="display:none">
            <div class="section-title">Dados do Emitente</div>
            <div class="card">
                <div class="form-group"><label>Sua Empresa (Nome)</label><input id="cfg-nome"></div>
                <div class="form-group"><label>Seu CNPJ / CPF</label><input id="cfg-doc"></div>
                <div class="form-group"><label>Endere√ßo Completo</label><input id="cfg-end"></div>
                <div class="form-group"><label>Seu WhatsApp</label><input id="cfg-tel"></div>
                <button class="btn btn-primary" onclick="app.saveConfig()">ATUALIZAR MEUS DADOS</button>
            </div>
        </section>
    </main>

    <!-- MODAL DE PREVIEW (ONDE O PDF √â MONTADO) -->
    <div id="modal-preview">
        <div id="modal-header">
            <h2 style="font-size: 16px;">Pr√©-visualiza√ß√£o do Documento</h2>
            <button onclick="ui.closeModal()" style="background: none; border: none; font-size: 30px; cursor: pointer;">&times;</button>
        </div>
        <div id="preview-body">
            <!-- O PDF ser√° renderizado aqui dentro de um .pdf-page -->
        </div>
        <div style="background: white; padding: 20px; border-top: 1px solid var(--border);">
            <button class="btn btn-success" onclick="app.downloadPDF()" style="height: 55px; font-size: 18px;">
                CONFIRMAR E DESCARREGAR PDF
            </button>
        </div>
    </div>

    <!-- Div invis√≠vel usada como ponte de renderiza√ß√£o final para evitar erros de CSS -->
    <div id="render-bridge" style="position: absolute; left: -9999px; top: -9999px; width: 210mm;"></div>

    <script>
        // --- MOTOR LOGICO ---
        const app = {
            db: null,
            carrinho: [],
            clientes: [],
            produtos: [],
            config: {},

            init() {
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('main-nav').style.display = 'grid';
                document.getElementById('main-app').style.display = 'block';
                this.initDB();
            },

            initDB() {
                const request = indexedDB.open("EnterpriseERP", 5);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if(!db.objectStoreNames.contains("clientes")) db.createObjectStore("clientes", { keyPath: "id", autoIncrement: true });
                    if(!db.objectStoreNames.contains("produtos")) db.createObjectStore("produtos", { keyPath: "id", autoIncrement: true });
                    if(!db.objectStoreNames.contains("config")) db.createObjectStore("config", { keyPath: "id" });
                };
                request.onsuccess = (e) => {
                    this.db = e.target.result;
                    this.loadAll();
                };
            },

            loadAll() {
                this.db.transaction("clientes").objectStore("clientes").getAll().onsuccess = (e) => {
                    this.clientes = e.target.result;
                    ui.renderClientes();
                };
                this.db.transaction("produtos").objectStore("produtos").getAll().onsuccess = (e) => {
                    this.produtos = e.target.result;
                    ui.renderProdutos();
                };
                this.db.transaction("config").objectStore("config").get(1).onsuccess = (e) => {
                    if(e.target.result) {
                        this.config = e.target.result;
                        ui.fillConfig();
                    }
                };
            },

            saveConfig() {
                const data = {
                    id: 1,
                    nome: document.getElementById('cfg-nome').value,
                    doc: document.getElementById('cfg-doc').value,
                    end: document.getElementById('cfg-end').value,
                    tel: document.getElementById('cfg-tel').value
                };
                this.db.transaction("config", "readwrite").objectStore("config").put(data).onsuccess = () => {
                    this.config = data;
                    ui.toast("Perfil atualizado com sucesso!");
                };
            },

            saveCliente() {
                const cli = {
                    nome: document.getElementById('cli-nome').value,
                    doc: document.getElementById('cli-doc').value,
                    tel: document.getElementById('cli-tel').value
                };
                if(!cli.nome) return ui.toast("O nome do cliente √© obrigat√≥rio");
                this.db.transaction("clientes", "readwrite").objectStore("clientes").add(cli).onsuccess = () => {
                    ui.clearInputs(['cli-nome', 'cli-doc', 'cli-tel']);
                    this.loadAll();
                    ui.toast("Cliente cadastrado!");
                };
            },

            saveProduto() {
                const prod = {
                    nome: document.getElementById('item-nome').value,
                    preco: parseFloat(document.getElementById('item-preco').value) || 0
                };
                if(!prod.nome) return ui.toast("O nome do item √© obrigat√≥rio");
                this.db.transaction("produtos", "readwrite").objectStore("produtos").add(prod).onsuccess = () => {
                    ui.clearInputs(['item-nome', 'item-preco']);
                    this.loadAll();
                    ui.toast("Item adicionado ao cat√°logo!");
                };
            },

            addItem() {
                const sel = document.getElementById('venda-item-select');
                const nome = sel.value;
                const preco = parseFloat(document.getElementById('venda-item-preco').value);
                
                if(!nome || isNaN(preco)) return ui.toast("Selecione um item e informe o pre√ßo");
                
                this.carrinho.push({ nome, preco });
                ui.renderCarrinho();
                ui.toast("Item adicionado");
            },

            removeItem(idx) {
                this.carrinho.splice(idx, 1);
                ui.renderCarrinho();
            },

            preparePDF() {
                const cliId = document.getElementById('venda-cliente').value;
                if(!cliId) return ui.toast("Selecione um cliente primeiro");
                if(this.carrinho.length === 0) return ui.toast("O or√ßamento est√° vazio");

                const cliente = this.clientes.find(c => c.id == cliId);
                const total = this.carrinho.reduce((a, b) => a + b.preco, 0);
                const dataDoc = new Date().toLocaleDateString('pt-BR');
                const refDoc = "#" + Date.now().toString().slice(-6);

                // Montar HTML do PDF
                const html = `
                    <div class="pdf-page" id="documento-final">
                        <div class="pdf-header">
                            <div class="pdf-company">
                                <h1>${this.config.nome || 'NOME DA EMPRESA'}</h1>
                                <p>CNPJ/CPF: ${this.config.doc || '---'}</p>
                                <p>${this.config.end || 'Endere√ßo n√£o configurado'}</p>
                                <p>Tel: ${this.config.tel || '---'}</p>
                            </div>
                            <div class="pdf-meta">
                                <h2>OR√áAMENTO</h2>
                                <p>Data: ${dataDoc}</p>
                                <p>N¬∫: ${refDoc}</p>
                            </div>
                        </div>

                        <div class="pdf-info-box">
                            <div class="pdf-info-card">
                                <h3>Destinat√°rio / Cliente</h3>
                                <p>${cliente.nome}</p>
                                <div style="font-size: 9pt; color: #64748b; margin-top:5px">
                                    Documento: ${cliente.doc || 'N√£o informado'}<br>
                                    Contato: ${cliente.tel || 'N√£o informado'}
                                </div>
                            </div>
                            <div class="pdf-info-card">
                                <h3>Status do Documento</h3>
                                <p>V√ÅLIDO POR 10 DIAS</p>
                                <div style="font-size: 9pt; color: #64748b; margin-top:5px">
                                    Este documento √© uma proposta comercial e n√£o possui validade fiscal autom√°tica.
                                </div>
                            </div>
                        </div>

                        <table class="pdf-table">
                            <thead>
                                <tr>
                                    <th style="width: 70%">DESCRI√á√ÉO DOS SERVI√áOS / PRODUTOS</th>
                                    <th style="width: 30%; text-align: right">VALOR UNIT.</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${this.carrinho.map(it => `
                                    <tr>
                                        <td>${it.nome}</td>
                                        <td style="text-align: right">R$ ${it.preco.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>

                        <div class="pdf-total-container">
                            <div class="pdf-total-box">
                                <div class="pdf-total-label">VALOR TOTAL DA PROPOSTA</div>
                                <div class="pdf-total-value">R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                            </div>
                        </div>

                        <div style="margin-top: 50px; font-size: 10pt;">
                            <p><b>Observa√ß√µes:</b></p>
                            <p style="color: #475569">- Pagamento conforme acordado entre as partes.</p>
                            <p style="color: #475569">- Execu√ß√£o imediata ap√≥s aprova√ß√£o.</p>
                        </div>

                        <div class="pdf-footer">
                            Gerado por Enterprise ERP V10.3 - Sistema de Gest√£o Profissional
                        </div>
                    </div>
                `;

                document.getElementById('preview-body').innerHTML = html;
                document.getElementById('modal-preview').style.display = 'flex';
            },

            downloadPDF() {
                const source = document.getElementById('documento-final');
                
                // IMPORTANTE: Movemos o elemento para a "ponte" de renderiza√ß√£o vis√≠vel para o html2pdf capturar
                const bridge = document.getElementById('render-bridge');
                bridge.innerHTML = source.outerHTML;
                
                ui.toast("Processando arquivo...");

                const opt = {
                    margin: 0,
                    filename: `Orcamento_${Date.now()}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { 
                        scale: 2, 
                        useCORS: true, 
                        letterRendering: true,
                        scrollY: 0,
                        scrollX: 0
                    },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                html2pdf().set(opt).from(bridge.firstChild).save().then(() => {
                    ui.toast("PDF gerado com sucesso!");
                    ui.closeModal();
                    bridge.innerHTML = ''; // Limpa a ponte
                }).catch(err => {
                    console.error(err);
                    ui.toast("Erro ao gerar PDF.");
                });
            }
        };

        // --- INTERFACE ---
        const ui = {
            tab(t) {
                document.querySelectorAll('main section').forEach(s => s.style.display = 'none');
                document.querySelectorAll('nav div').forEach(d => d.classList.remove('active'));
                document.getElementById(`sec-${t}`).style.display = 'block';
                document.getElementById(`tab-${t}`).classList.add('active');
            },

            toast(msg) {
                const t = document.getElementById('toast');
                t.innerText = msg;
                t.style.display = 'block';
                setTimeout(() => t.style.display = 'none', 3000);
            },

            clearInputs(ids) {
                ids.forEach(id => document.getElementById(id).value = '');
            },

            fillConfig() {
                document.getElementById('cfg-nome').value = app.config.nome || '';
                document.getElementById('cfg-doc').value = app.config.doc || '';
                document.getElementById('cfg-end').value = app.config.end || '';
                document.getElementById('cfg-tel').value = app.config.tel || '';
            },

            renderClientes() {
                const sel = document.getElementById('venda-cliente');
                sel.innerHTML = '<option value="">Selecione...</option>' + 
                    app.clientes.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
                
                document.getElementById('lista-clientes-cad').innerHTML = app.clientes.map(c => `
                    <div class="card">
                        <b>${c.nome}</b><br>
                        <small>${c.doc || 'Sem documento'} | ${c.tel || 'Sem tel'}</small>
                    </div>
                `).join('');
            },

            renderProdutos() {
                const sel = document.getElementById('venda-item-select');
                sel.innerHTML = '<option value="">Selecione um item...</option>' + 
                    app.produtos.map(p => `<option value="${p.nome}" data-price="${p.preco}">${p.nome}</option>`).join('');

                document.getElementById('lista-produtos-cad').innerHTML = app.produtos.map(p => `
                    <div class="card">
                        <b>${p.nome}</b><br>
                        <small>Pre√ßo: R$ ${p.preco.toFixed(2)}</small>
                    </div>
                `).join('');
            },

            autoPreco() {
                const sel = document.getElementById('venda-item-select');
                const price = sel.options[sel.selectedIndex].dataset.price;
                if(price) document.getElementById('venda-item-preco').value = price;
            },

            renderCarrinho() {
                const container = document.getElementById('carrinho-lista');
                if(app.carrinho.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">Nenhum item adicionado.</p>';
                } else {
                    container.innerHTML = app.carrinho.map((it, i) => `
                        <div class="list-item">
                            <div>
                                <div style="font-weight: bold;">${it.nome}</div>
                                <div style="color: var(--primary); font-size: 12px;">R$ ${it.preco.toFixed(2)}</div>
                            </div>
                            <div class="remove-btn" onclick="app.removeItem(${i})">REMOVER</div>
                        </div>
                    `).join('');
                }
                const total = app.carrinho.reduce((a, b) => a + b.preco, 0);
                document.getElementById('venda-total').innerText = `R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            },

            closeModal() {
                document.getElementById('modal-preview').style.display = 'none';
            }
        };

        // Previnir zoom acidental em dispositivos m√≥veis ao focar inputs
        document.addEventListener('gesturestart', function (e) { e.preventDefault(); });
    </script>

</body>
</html>
